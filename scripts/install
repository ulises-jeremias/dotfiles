#!/usr/bin/env bash

ROOT=$(dirname $0)

. $ROOT/../lib/log.sh

#==========================================
# Args declaration
#==========================================
. $ROOT/../lib/flags/declares.sh

variables["--os"]="os"
variables["-l"]="log_file";
variables["--log-file"]="log_file";
variables["--dotfiles-dir"]="dotfiles_dir";
variables["--pkgs"]="pkgs";

. $ROOT/../lib/flags/arguments.sh

#==========================================
# Default argument values and preprocessing
#==========================================
os=${os:-""}
time_str=$(date +'%m-%d-%y_%H:%M:%S')
log_file=${log_file:-"/tmp/install_progress_log_$time_str.txt"}
dotfiles_dir=${dotfiles_dir:-"$HOME/dotfiles"}

[ ! -f "$log_file" ] && touch $log_file

if has_param '-u' "$@" || has_param '--upgrade' "$@"; then
    upgrade_flag="-u"
fi

if has_param '-c' "$@" || has_param '--clean' "$@"; then
    clean_flag="-c"
fi

#==========================================
# Install dependencies according to os
#==========================================
if ! has_param '--no-deps' "$@" && [ "$os" != "" ]; then
    $ROOT/install-pkgs \
        -l $log_file $upgrade_flag --os $os \
        --pkgs $pkgs
fi

echo

#==========================================
# Install dotfiles according to os
#==========================================
$ROOT/install-dotfiles -l $log_file --os $os --dotfiles-dir $dotfiles_dir $clean_flag

#==========================================
# Set zsh as the default shell
#==========================================
echo
sudo chsh -s /bin/zsh

#==========================================
# Give the user a summary of what has
# been installed
#==========================================
echo -e "\n====== Summary ======\n"
cat $log_file
echo
echo "Enjoy dotfiles :D"
rm $log_file
