#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Power Menu Wrapper
## Quickshell-first entrypoint for session/power drawer
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Usage:
##     @script.name [OPTIONS]
##
## Options:
##     -h, --help              Show this help message
##         --mode=MODE         Set mode: auto (default), quickshell, minimal
##
## Examples:
##     @script.name
##     @script.name --mode=minimal

set -euo pipefail

# Source EasyOptions for argument parsing
source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

MODE=${mode:-auto}
launch_quickshell() {
  pgrep -x quickshell >/dev/null 2>&1 || return 1
  dots-quickshell ipc session toggle
  return 0
}

launch_minimal() {
  cat <<EOF
1) Lock
2) Suspend
3) Logout
4) Reboot
5) Shutdown
EOF
  read -r -p "Select action [1-5]: " choice
  case "$choice" in
    1) ~/.local/bin/dots-lockscreen --lock ;;
    2) systemctl suspend ;;
    3) loginctl terminate-session "${XDG_SESSION_ID-}" ;;
    4) systemctl -i reboot ;;
    5) systemctl -i poweroff ;;
    *) exit 0 ;;
  esac
}

main() {
  case "$MODE" in
    quickshell)
      launch_quickshell || {
        echo "quickshell is not running" >&2
        exit 1
      }
      ;;
    minimal)
      launch_minimal
      ;;
    auto | *)
      launch_quickshell || launch_minimal
      ;;
  esac
}

main "$@"
