#!/usr/bin/env bash

## dots-clipboard: Clipboard manager wrapper
## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
## Wayland order (auto): quickshell > copyq > cliphist+(fuzzel|wofi) > minimal
## X11 order (auto): quickshell > copyq > minimal
## Usage:
##   @script.name [OPTIONS]
## Options:
##   -h, --help            Show help
##       --backend=NAME    Force backend: quickshell|copyq|cliphist|minimal
## Examples:
##   @script.name --backend=copyq   # force copyq GUI
##   @script.name --backend=cliphist # force cliphist picker

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

BACKEND=${backend:-auto}

is_wayland() { [[ ${XDG_SESSION_TYPE:-} == wayland ]]; }

menu_pick() {
  local title="$1"
  if command -v fuzzel >/dev/null 2>&1; then
    fuzzel --prompt "$title> "
  elif command -v wofi >/dev/null 2>&1; then
    wofi --dmenu --prompt "$title> "
  else
    cat
  fi
}

do_copyq() {
  command -v copyq >/dev/null 2>&1 || return 1
  exec copyq show
}
do_quickshell() {
  pgrep -x quickshell >/dev/null 2>&1 || return 1
  dots-quickshell ipc utilities toggle
  return 0
}
do_cliphist() {
  command -v cliphist >/dev/null 2>&1 || return 1
  local selection
  selection=$(cliphist list | menu_pick Clipboard) || true
  [[ -z $selection ]] && exit 0
  cliphist decode <<<"$selection" | wl-copy
  return 0
}

minimal_fallback() {
  echo "[dots-clipboard] minimal fallback" >&2
  if command -v wl-paste >/dev/null 2>&1; then
    wl-paste | head -c 500
  else
    echo "(no data)"
  fi
}

case "$BACKEND" in
  copyq) do_copyq || {
    echo "copyq not available" >&2
    exit 1
  } ;;
  cliphist)
    is_wayland || {
      echo "cliphist is Wayland-only" >&2
      exit 1
    }
    do_cliphist || {
      echo "cliphist not available" >&2
      exit 1
    }
    ;;
  quickshell) do_quickshell || {
    echo "quickshell is not running" >&2
    exit 1
  } ;;
  minimal) minimal_fallback ;;
  auto | *)
    do_quickshell && exit 0
    if is_wayland; then
      do_copyq || do_cliphist || minimal_fallback
    else
      do_copyq || minimal_fallback
    fi
    ;;
esac
