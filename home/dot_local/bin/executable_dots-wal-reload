#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Enhanced wal-reload utility script with improved reliability and user experience
## No longer relies on external state files, minimizes dependencies

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Global counters for summary
UPDATED_APPS=()
FAILED_APPS=()
SKIPPED_APPS=()

# Function to show status
show_status() {
  echo -e "${CYAN}ðŸŽ¨${NC} $1"
}

# Function to show success
show_success() {
  echo -e "${GREEN}âœ…${NC} $1"
}

# Function to show error
show_error() {
  echo -e "${RED}âŒ${NC} $1"
}

# Function to show info
show_info() {
  echo -e "${CYAN}â„¹ï¸${NC} $1"
}

# Function to show warning
show_warning() {
  echo -e "${YELLOW}âš ï¸${NC} $1"
}

# Function to send notification
send_notification() {
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "$1" "$2" -t 3000 -i "$3" 2>/dev/null || true
  fi
}

# Function to check if a command exists and warn if not
check_command() {
  local cmd=$1
  local description=$2
  local required=${3:-false}

  if ! command -v "$cmd" >/dev/null 2>&1; then
    if [[ $required == "true" ]]; then
      show_error "$description ($cmd) is not installed and is required!"
      FAILED_APPS+=("$description")
      return 1
    else
      show_warning "$description ($cmd) is not installed, skipping related updates"
      SKIPPED_APPS+=("$description")
      return 1
    fi
  fi
  return 0
}

# Function to safely execute commands with error handling
safe_execute() {
  local description=$1
  shift

  show_status "$description..."

  if "$@" >/dev/null 2>&1; then
    show_success "$description completed"
    UPDATED_APPS+=("$description")
    return 0
  else
    show_error "$description failed"
    FAILED_APPS+=("$description")
    return 1
  fi
}

# Function to reload wal
reload_wal() {
  show_status "Reloading pywal colorscheme..."

  if ! check_command wal "pywal" true; then
    exit 1
  fi

  # Check if the ~/.cache/wal directory exists
  if [[ ! -d "${HOME}/.cache/wal" ]]; then
    show_error "The ~/.cache/wal directory does not exist. Please run wal first."
    send_notification "âŒ Wal Error" "No wal cache found. Run wal first." "dialog-error"
    exit 1
  fi

  # Reset the colorscheme
  if wal -R -q 2>/dev/null; then
    show_success "Pywal colorscheme reloaded"
  else
    show_error "Failed to reload wal colorscheme"
    exit 1
  fi
}

# Function to reload Quickshell colors
reload_quickshell() {
  if ! pgrep -x quickshell >/dev/null 2>&1; then
    show_warning "Quickshell is not running, skipping reload"
    SKIPPED_APPS+=("Quickshell")
    return 0
  fi

  show_status "Reloading Quickshell colors..."

  if dots-quickshell ipc colours reload >/dev/null 2>&1; then
    show_success "Quickshell colors reloaded"
    UPDATED_APPS+=("Quickshell")
  else
    show_error "Failed to reload Quickshell colors"
    FAILED_APPS+=("Quickshell")
  fi
}

# Function to reload lockscreen
reload_lockscreen() {
  # Use dots-lockscreen for Wayland, betterlockscreen for X11
  if [[ ${XDG_SESSION_TYPE:-} == "wayland" ]]; then
    if ! check_command dots-lockscreen "dots-lockscreen"; then
      return 0
    fi

    # Move to background to not block the reload process
    (
      local current_wallpaper="$HOME/.cache/current_wallpaper"

      if [[ -f $current_wallpaper ]]; then
        local wallpaper_path
        wallpaper_path=$(cat "$current_wallpaper")

        if [[ -f $wallpaper_path ]]; then
          show_status "Updating lockscreen with current wallpaper (background)..."
          if dots-lockscreen --update="$wallpaper_path" >/dev/null 2>&1; then
            show_success "Lockscreen updated"
            UPDATED_APPS+=("Lockscreen")
          else
            show_error "Lockscreen update failed"
            FAILED_APPS+=("Lockscreen")
          fi
        else
          show_warning "Current wallpaper file not found: $wallpaper_path"
          SKIPPED_APPS+=("Lockscreen")
        fi
      else
        show_warning "Current wallpaper cache not found: $current_wallpaper"
        # Fallback: try to use wal wallpaper
        local wal_wallpaper
        wal_wallpaper=$(grep "wallpaper" "$HOME/.cache/wal/colors.sh" 2>/dev/null | cut -d"'" -f2)
        if [[ -f $wal_wallpaper ]]; then
          if dots-lockscreen --update="$wal_wallpaper" >/dev/null 2>&1; then
            show_success "Lockscreen updated (wal fallback)"
            UPDATED_APPS+=("Lockscreen")
          else
            FAILED_APPS+=("Lockscreen")
          fi
        else
          SKIPPED_APPS+=("Lockscreen")
        fi
      fi
    ) &

    show_status "Lockscreen update started in background..."
  else
    # X11 fallback - use betterlockscreen if available
    if ! check_command betterlockscreen "Betterlockscreen"; then
      return 0
    fi

    # Move to background to not block the reload process
    (
      local current_wallpaper="$HOME/.config/wpg/.current"

      if [[ -f $current_wallpaper ]]; then
        show_status "Updating betterlockscreen with current wallpaper (background)..."
        if betterlockscreen -u "$current_wallpaper" >/dev/null 2>&1; then
          show_success "Betterlockscreen updated"
          UPDATED_APPS+=("Betterlockscreen")
        else
          show_error "Betterlockscreen update failed"
          FAILED_APPS+=("Betterlockscreen")
        fi
      else
        show_warning "Current wallpaper not found: $current_wallpaper"
        # Fallback: try to use wal wallpaper
        local wal_wallpaper
        wal_wallpaper=$(grep "wallpaper" "$HOME/.cache/wal/colors.sh" 2>/dev/null | cut -d"'" -f2)
        if [[ -f $wal_wallpaper ]]; then
          if betterlockscreen -u "$wal_wallpaper" >/dev/null 2>&1; then
            show_success "Betterlockscreen updated (wal fallback)"
            UPDATED_APPS+=("Betterlockscreen")
          else
            FAILED_APPS+=("Betterlockscreen")
          fi
        else
          SKIPPED_APPS+=("Betterlockscreen")
        fi
      fi
    ) &

    show_status "Betterlockscreen update started in background..."
  fi
}

# Function to reload Discord theme
reload_discord() {
  if ! check_command wal-discord "wal-discord"; then
    return 0
  fi

  show_status "Updating Discord theme..."

  # Generate the style.css file and BetterDiscord theme
  if wal-discord >/dev/null 2>&1 && wal-discord -t >/dev/null 2>&1; then
    show_success "Discord theme updated"
  else
    show_error "Failed to update Discord theme"
  fi
}

# Function to apply smart colors after wal reload
reload_smart_colors() {
  if ! command -v dots-smart-colors >/dev/null 2>&1; then
    show_warning "dots-smart-colors not found, skipping smart color integration"
    return 0
  fi

  show_status "Applying smart theme-adaptive colors..."

  # Generate all smart color files in centralized location
  show_status "Generating smart color files for all applications..."
  if dots-smart-colors --generate --m3 >/dev/null 2>&1; then
    show_success "Smart color files generated successfully"
  else
    show_warning "Failed to generate smart color files, falling back to basic export"
    # Fallback to old method
    if eval "$(dots-smart-colors --export 2>/dev/null)"; then
      show_success "Smart colors exported to environment (fallback mode)"
    else
      show_warning "Failed to export smart colors to environment"
      return 0
    fi
  fi

  # Load smart colors into current environment
  if [[ -f "$HOME/.cache/dots/smart-colors/colors.env" ]]; then
    source "$HOME/.cache/dots/smart-colors/colors.env" 2>/dev/null && show_success "Smart colors loaded into environment"
  fi

  # Apply smart colors to applications
  apply_smart_colors_to_apps

  UPDATED_APPS+=("Smart Colors Integration")
}

# Apply smart colors to running applications
apply_smart_colors_to_apps() {
  local smart_colors_applied=false

  # Update Quickshell if running
  if pgrep -x quickshell >/dev/null 2>&1; then
    show_status "Quickshell detected, reloading colors..."
    if dots-quickshell ipc colours reload >/dev/null 2>&1; then
      show_success "Quickshell colors reloaded"
      UPDATED_APPS+=("Quickshell with smart colors")
      smart_colors_applied=true
    else
      show_warning "Quickshell color reload failed"
      FAILED_APPS+=("Quickshell color reload")
    fi
  fi

  # Update Hyprland if running
  if pgrep Hyprland >/dev/null 2>&1; then
    show_status "Hyprland detected, applying smart colors..."

    local hypr_colors_dir="$HOME/.config/hypr/hyprland.conf.d"
    if [[ -d $hypr_colors_dir ]]; then
      if [[ -f "$HOME/.cache/dots/smart-colors/colors-hyprland.conf" ]]; then
        cp "$HOME/.cache/dots/smart-colors/colors-hyprland.conf" "$hypr_colors_dir/colors.conf" 2>/dev/null

        if hyprctl reload >/dev/null 2>&1; then
          show_success "Hyprland colors updated"
          UPDATED_APPS+=("Hyprland with smart colors")
          smart_colors_applied=true
        fi
      fi
    fi
  fi

  if [[ $smart_colors_applied == "true" ]]; then
    show_success "Smart colors applied to running applications"
  else
    show_info "Smart color files generated, will be used when applications restart"
  fi
}

# Function to reload additional applications
reload_additional_apps() {
  show_status "Checking for additional applications to reload..."

  # Reload Alacritty if it's running and config exists
  if pgrep alacritty >/dev/null && [[ -f "$HOME/.cache/wal/colors-alacritty.yml" ]]; then
    show_status "Alacritty detected, colors should auto-reload"
  fi

  # Reload Kitty if it's running
  if pgrep kitty >/dev/null && command -v kitty >/dev/null 2>&1; then
    local kitty_colors_file="$HOME/.cache/dots/smart-colors/colors-kitty.conf"
    if [[ ! -f $kitty_colors_file ]]; then
      kitty_colors_file="$HOME/.cache/wal/colors-kitty.conf"
    fi

    if kitty @ set-colors --all --configured "$kitty_colors_file" 2>/dev/null; then
      show_success "Kitty colors reloaded"
    fi
  fi

  # Reload VSCode theme if wal-theme-vscode is available
  if command -v wal-theme-vscode >/dev/null 2>&1; then
    safe_execute "Updating VSCode theme" wal-theme-vscode
  fi

  # Note: Polybar smart color integration is handled by the smart colors section
}

# Function to reload yazi colors
reload_yazi() {
  if pgrep -x yazi >/dev/null 2>&1; then
    show_status "Reloading yazi colors..."
    show_info "Yazi inherits terminal colors â€” will update on next launch"
  else
    show_info "Yazi colors updated (not currently running)"
  fi
}

# Function to reload GTK themes
reload_gtk_themes() {
  show_status "Updating GTK themes to match wallpaper..."

  # Source GTK theme manager
  if [[ -f "$HOME/.local/lib/dots/gtk-theme-manager.sh" ]]; then
    source "$HOME/.local/lib/dots/gtk-theme-manager.sh"

    # Apply GTK theme based on current rice (if any) or wallpaper
    if apply_rice_gtk_theme 2>/dev/null; then
      show_success "GTK themes updated automatically"
      UPDATED_APPS+=("GTK themes (automatic)")
    else
      show_warning "GTK theme update failed, keeping current theme"
      FAILED_APPS+=("GTK themes")
    fi
  else
    show_warning "GTK theme manager not found, skipping GTK theme update"
    SKIPPED_APPS+=("GTK themes")
  fi
}

# Function to reload snappy-switcher theme
reload_snappy_switcher() {
  show_status "Syncing snappy-switcher theme with current rice..."

  if ! command -v dots-snappy-switcher >/dev/null 2>&1; then
    show_warning "dots-snappy-switcher not found, skipping switcher theme sync"
    SKIPPED_APPS+=("Snappy Switcher")
    return 0
  fi

  if dots-snappy-switcher apply-rice-theme >/dev/null 2>&1; then
    show_success "Snappy switcher theme synchronized"
    UPDATED_APPS+=("Snappy Switcher")
  else
    show_warning "Could not synchronize snappy switcher theme"
    FAILED_APPS+=("Snappy Switcher")
  fi
}

# Function to reload hyprpaper (Hyprland wallpaper daemon)
reload_hyprpaper() {
  # Only run on Hyprland
  if [[ ${XDG_SESSION_TYPE:-} != "wayland" ]] || [[ ${XDG_CURRENT_DESKTOP:-} != *"Hyprland"* ]]; then
    return 0
  fi

  if ! check_command hyprpaper "Hyprpaper" false; then
    return 0
  fi

  show_status "Updating wallpaper with hyprpaper..."

  # Use dots-hyprpaper-set helper if available
  if command -v dots-hyprpaper-set >/dev/null 2>&1; then
    if DOTS_THEME_PIPELINE=1 dots-hyprpaper-set; then
      show_success "Hyprpaper wallpaper updated"
      UPDATED_APPS+=("Hyprpaper")
      return 0
    else
      show_warning "Hyprpaper update failed"
      FAILED_APPS+=("Hyprpaper")
      return 1
    fi
  else
    show_warning "dots-hyprpaper-set not found, skipping hyprpaper update"
    SKIPPED_APPS+=("Hyprpaper")
    return 1
  fi
}

# Function to update current rice if applicable
update_current_rice() {
  local rice_config="$HOME/.cache/dots/current_rice"

  if [[ -f $rice_config ]]; then
    source "$rice_config"
    if [[ -n $CURRENT_RICE && -f "$HOME/.local/share/dots/rices/$CURRENT_RICE/apply.sh" ]]; then
      show_status "Current rice detected: $CURRENT_RICE"
      show_status "You may want to reapply the rice to fully integrate new colors"
      # Optionally: auto-reapply rice
      # "$HOME/.local/share/dots/rices/$CURRENT_RICE/apply.sh"
    fi
  fi
}

# Function to show reload summary
show_summary() {
  echo ""
  echo -e "${PURPLE}ðŸŽ¨ Wal Reload Summary ðŸŽ¨${NC}"
  echo ""
  show_success "Pywal colorscheme has been reloaded"
  echo ""

  if [[ ${#UPDATED_APPS[@]} -gt 0 ]]; then
    echo -e "${GREEN}âœ… Successfully updated (${#UPDATED_APPS[@]}):${NC}"
    printf '  â€¢ %s\n' "${UPDATED_APPS[@]}"
    echo ""
  fi

  if [[ ${#SKIPPED_APPS[@]} -gt 0 ]]; then
    echo -e "${YELLOW}âš ï¸  Skipped (${#SKIPPED_APPS[@]}):${NC}"
    printf '  â€¢ %s\n' "${SKIPPED_APPS[@]}"
    echo ""
  fi

  if [[ ${#FAILED_APPS[@]} -gt 0 ]]; then
    echo -e "${RED}âŒ Failed (${#FAILED_APPS[@]}):${NC}"
    printf '  â€¢ %s\n' "${FAILED_APPS[@]}"
    echo ""
  fi

  local total_updated=${#UPDATED_APPS[@]}
  local total_failed=${#FAILED_APPS[@]}

  if [[ $total_failed -eq 0 ]]; then
    echo -e "${GREEN}ðŸŽ‰ All operations completed successfully!${NC}"
    send_notification "ðŸŽ¨ Wal Reload Complete" "Successfully updated $total_updated applications" "applications-graphics"
  else
    echo -e "${YELLOW}âš ï¸  Completed with $total_failed failures${NC}"
    send_notification "ðŸŽ¨ Wal Reload Completed" "Updated $total_updated apps, $total_failed failed" "dialog-warning"
  fi

  echo ""
  echo -e "${CYAN}ðŸ’¡ Tip:${NC} Some applications may require a restart to fully apply new colors"
}

# Main function
main() {
  echo -e "${PURPLE}ðŸŽ¨ Enhanced Wal Reload Script ðŸŽ¨${NC}"
  echo ""

  # Set wallpaper for Hyprland (must be first)
  reload_hyprpaper

  # Core wal reload (must be before smart colors)
  reload_wal

  # Apply smart colors after all standard wal operations (must be before app reloads)
  reload_smart_colors

  # Reload Quickshell (fast, sequential for reliability)
  reload_quickshell

  # Reload yazi colors (inherits terminal palette)
  reload_yazi

  # Parallel operations - independent tasks that can run simultaneously
  (
    reload_discord
  ) &
  local discord_pid=$!

  (
    reload_additional_apps
  ) &
  local additional_pid=$!

  (
    reload_gtk_themes
  ) &
  local gtk_pid=$!

  (
    reload_snappy_switcher
  ) &
  local snappy_pid=$!

  # Move slow operations to background (already in background)
  reload_lockscreen

  # Wait for parallel operations to complete
  wait $discord_pid 2>/dev/null || true
  wait $additional_pid 2>/dev/null || true
  wait $gtk_pid 2>/dev/null || true
  wait $snappy_pid 2>/dev/null || true

  # Update rice integration (after all reloads)
  update_current_rice

  # Show summary
  show_summary
}

# Parse arguments
case "${1:-}" in
  "help" | "-h" | "--help")
    echo "Enhanced Wal Reload Script with Smart Colors Integration"
    echo ""
    echo "Usage: $0 [option]"
    echo ""
    echo "Options:"
    echo "  (no args)      - Full reload of wal and all supported applications"
    echo "  help, -h       - Show this help"
    echo ""
    echo "Supported applications:"
    echo "  â€¢ Quickshell desktop shell (with smart color reload)"
    echo "  â€¢ Hyprland (with smart color integration)"
    echo "  â€¢ Discord (via wal-discord)"
    echo "  â€¢ Kitty terminal"
    echo "  â€¢ Alacritty terminal"
    echo "  â€¢ VSCode (via wal-theme-vscode)"
    echo ""
    echo "Smart Colors Features:"
    echo "  â€¢ Theme-adaptive color selection for better readability"
    echo "  â€¢ Automatic semantic color mapping (error, success, info, etc.)"
    echo "  â€¢ M3 Material Design color scheme generation"
    echo "  â€¢ Hyprland border and window decoration integration"
    ;;
  *)
    main
    ;;
esac
