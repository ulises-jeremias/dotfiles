#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Control the microphone
##
## Usage:
##   @script.name [OPTIONS]
##
## Options:
##   -h, --help              Show this help message
##   -t, --toggle            Switch microphone to the opposite status
##       --muted-color=COLOR Font color for muted icon
##       --unmuted-color=COLOR Font color for unmuted icon
##       --no-unmuted         Don't show icon when the microphone is enabled

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

reset=""
muted_color="${muted_color:-}"
unmuted_color="${unmuted_color:-}"
exec_toggle="${toggle:-false}"
no_unmuted="${no_unmuted:-false}"

get_default_source() {
  # Get the ID of the default microphone (source)
  local default_input_name
  default_input_name="$(wpctl status | grep "Audio/Source" | awk '{print $3}')"
  pw-cli ls Node | grep -B 10 "$default_input_name" | grep -E "^\s*id" | awk '{print $2}' | tr -d ','
}

status() {
  DEFAULT_SOURCE=$(get_default_source)
  MUTED=$(wpctl get-volume "$DEFAULT_SOURCE" | grep -oE '\[MUTED\]')
  if [[ -n $MUTED ]]; then
    echo -e "${muted_color}${reset}" # Muted icon
  else
    [[ ${no_unmuted} != true ]] && echo -e "${unmuted_color}${reset}" # Unmuted icon
  fi
}

listen() {
  status
  wpctl subscribe | while read -r event; do
    if echo "$event" | grep -q "source" || echo "$event" | grep -q "server"; then
      status
    fi
  done
}

toggle() {
  DEFAULT_SOURCE=$(get_default_source)
  wpctl set-mute "$DEFAULT_SOURCE" toggle
}

if [[ ${exec_toggle} == true ]]; then
  toggle
  exit
fi

listen
