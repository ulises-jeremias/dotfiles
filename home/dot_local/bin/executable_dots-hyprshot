#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Hyprland screenshooter using grim, slurp, and swappy
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
##     @script.name [OPTION]
##
## Options:
##     -h, --help                Show this help message
##     -v, --version             Display script version
##     -f, --fullscreen          Take screenshot of entire screen
##     -r, --region              Select region to capture
##     -w, --window              Capture active window
##     -e, --edit                Screenshot with editor (swappy)
##     -c, --clipboard           Screenshot to clipboard

NAME=$(basename "$0")
VER="1.0"

SCREENSHOTS_DIR="${HOME}/Pictures/Screenshots"
TIMESTAMP="$(date +%Y%m%d_%H%M%S)"

# Create screenshots directory if it doesn't exist
mkdir -p "$SCREENSHOTS_DIR"

usage() {
  cat <<-EOF

 USAGE:  $NAME [OPTIONS]

 OPTIONS:

     -h,--help          Display this message
     -v,--version       Display script version
     -f,--fullscreen    Take screenshot of entire screen
     -r,--region        Select region to capture
     -w,--window        Capture active window
     -e,--edit          Screenshot with editor (swappy)
     -c,--clipboard     Screenshot to clipboard

 DEPENDENCIES:
     grim, slurp, swappy, wl-clipboard, notify-send

EOF
}

# Check dependencies
check_deps() {
  local missing=()

  command -v grim >/dev/null || missing+=("grim")
  command -v slurp >/dev/null || missing+=("slurp")
  command -v wl-copy >/dev/null || missing+=("wl-clipboard")

  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "Error: Missing required dependencies: ${missing[*]}"
    exit 1
  fi
}

# Send notification
notify_screenshot() {
  local file="$1"
  local mode="$2"

  if command -v notify-send >/dev/null; then
    notify-send -i "$file" "Screenshot" \
      "Saved $mode screenshot to:\n$(basename "$file")" \
      --expire-time=5000
  fi
}

# Screenshot functions
shoot() {
  local mode="${1:-fullscreen}"
  local file="${SCREENSHOTS_DIR}/screenshot_${TIMESTAMP}.png"

  case "$mode" in
    fullscreen)
      grim "$file" && notify_screenshot "$file" "full"
      ;;
    region)
      grim -g "$(slurp)" "$file" && [[ -f "$file" ]] && notify_screenshot "$file" "region"
      ;;
    window)
      # Get active window geometry from Hyprland
      local geometry
      geometry="$(hyprctl activewindow -j 2>/dev/null | jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' 2>/dev/null)"

      if [[ -n "$geometry" && "$geometry" != "null" ]]; then
        grim -g "$geometry" "$file" && notify_screenshot "$file" "window"
      else
        echo "Error: Could not get active window geometry"
        exit 1
      fi
      ;;
    edit)
      grim -g "$(slurp)" - | swappy -f -
      ;;
    clipboard)
      grim -g "$(slurp)" - | wl-copy && \
        command -v notify-send >/dev/null && \
        notify-send "Screenshot" "Copied to clipboard" --expire-time=3000
      ;;
  esac
}

# Main
case "${1:-}" in
  -h|--help)
    usage
    ;;
  -v|--version)
    echo "$NAME -- Version $VER"
    ;;
  -f|--fullscreen)
    check_deps
    shoot fullscreen
    ;;
  -r|--region)
    check_deps
    shoot region
    ;;
  -w|--window)
    check_deps
    shoot window
    ;;
  -e|--edit)
    check_deps
    if ! command -v swappy >/dev/null; then
      echo "Error: swappy is required for edit mode"
      exit 1
    fi
    shoot edit
    ;;
  -c|--clipboard)
    check_deps
    shoot clipboard
    ;;
  *)
    check_deps
    shoot fullscreen
    ;;
esac
