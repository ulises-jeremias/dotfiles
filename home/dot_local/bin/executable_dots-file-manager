#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## File Manager Launcher - Wrapper for exo-open FileManager
## Delegates to XDG default file manager configured via handlr/exo
##
## Usage:
##   @script.name [OPTIONS] [PATH]
##
## Options:
##   -h, --help          Show this help
##   -s, --select        Open default applications settings
##   -i, --info          Show current default file manager
##       --path=PATH     Path to open (default: current directory)

set -e

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

# Show current default file manager
show_info() {
  echo "File Manager Configuration"
  echo "=========================="
  echo ""

  if command -v handlr >/dev/null 2>&1; then
    local default_fm
    default_fm=$(handlr get inode/directory 2>/dev/null || echo "Not set")
    echo "Current default: $default_fm"
    echo ""
    echo "Available file managers:"
    # List .desktop files that handle inode/directory
    for desktop_dir in /usr/share/applications ~/.local/share/applications; do
      [[ ! -d $desktop_dir ]] && continue
      while IFS= read -r desktop_file; do
        [[ ! -f $desktop_file ]] && continue
        if grep -qi "MimeType=.*inode/directory" "$desktop_file" 2>/dev/null; then
          local name
          name=$(grep "^Name=" "$desktop_file" | head -1 | cut -d'=' -f2)
          local basename_file
          basename_file=$(basename "$desktop_file")
          echo "  - $basename_file ($name)"
        fi
      done < <(find "$desktop_dir" -maxdepth 1 -name "*.desktop" 2>/dev/null)
    done
  elif command -v xdg-mime >/dev/null 2>&1; then
    local default_fm
    default_fm=$(xdg-mime query default inode/directory 2>/dev/null || echo "Not set")
    echo "Current default: $default_fm"
  else
    echo "No XDG tools found (handlr or xdg-mime)"
  fi

  echo ""
  echo "To configure:"
  echo "  - dots-default-apps --gui"
  echo "  - dots-default-apps --type=file-manager"
  echo "  - handlr set inode/directory thunar.desktop"
}

# Open default applications settings
open_settings() {
  if command -v dots-default-apps >/dev/null 2>&1; then
    dots-default-apps --type=file-manager
  else
    echo "Error: dots-default-apps not found" >&2
    exit 1
  fi
}

# Launch file manager
launch_file_manager() {
  local path="${path:-$(pwd)}"

  if command -v exo-open >/dev/null 2>&1; then
    exo-open --launch FileManager "$path" &
  elif command -v handlr >/dev/null 2>&1; then
    handlr open "$path" &
  elif command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$path" &
  else
    echo "Error: No file manager launcher found (exo-open, handlr, or xdg-open)" >&2
    exit 1
  fi
}

# Main function
main() {
  if [[ ${help:-no} == yes ]]; then
    show_help
    exit 0
  fi

  if [[ ${info:-no} == yes ]]; then
    show_info
    exit 0
  fi

  if [[ ${select:-no} == yes ]]; then
    open_settings
    exit 0
  fi

  # Default: launch file manager
  launch_file_manager
}

main "$@"
