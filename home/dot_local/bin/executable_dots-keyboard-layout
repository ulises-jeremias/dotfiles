#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Program: dots-keyboard-layout
## Description: Keyboard layout toggler for Hyprland/Wayland/X11
##
## Usage: dots-keyboard-layout [OPTIONS]
##
## Options:
##   -t, --toggle        Toggle between configured layouts (default)
##   -c, --current       Show current layout info
##   -g, --get           Get current layout name only
##   -s, --settings      Open keyboard settings GUI
##   -h, --help          Show this help message
##
## Note: For comprehensive keyboard configuration including layouts, variants,
##       and options, use: dots-keyboard-settings (opens LXQt config GUI)
##
## Examples:
##   dots-keyboard-layout           # Toggle between layouts
##   dots-keyboard-layout --current # Show current layout
##   dots-keyboard-layout --settings # Open GUI settings

set -e

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

SCRIPT_NAME="$(basename "$0")"
readonly SCRIPT_NAME

# Define your preferred layouts here (edit as needed)
# Format: "layout:variant" (use empty string for no variant)
PREFERRED_LAYOUTS=(
  "us:"
  "es:"
  # Add more layouts as needed, e.g.:
  # "us:intl"
  # "latam:"
  # "gb:"
)

# Layout display names (for notifications)
declare -A LAYOUT_NAMES=(
  ["us:"]="US"
  ["us:intl"]="US International"
  ["es:"]="Spanish"
  ["latam:"]="Spanish LATAM"
  ["gb:"]="UK"
  ["de:"]="German"
  ["fr:"]="French"
)

# Detect current session type
detect_session() {
  if [[ -n ${HYPRLAND_INSTANCE_SIGNATURE:-} ]]; then
    echo "hyprland"
  elif [[ -n ${WAYLAND_DISPLAY:-} ]]; then
    echo "wayland"
  elif [[ -n ${I3SOCK:-} ]]; then
    echo "i3"
  else
    echo "x11"
  fi
}

# Get current layout
get_current_layout() {
  local session
  session=$(detect_session)

  case "$session" in
    hyprland)
      hyprctl getoption input:kb_layout -j 2>/dev/null | jq -r '.str' || echo "us"
      ;;
    wayland | i3 | x11)
      setxkbmap -query 2>/dev/null | awk '/layout/{print $2}' || echo "us"
      ;;
  esac
}

# Get current variant
get_current_variant() {
  local session
  session=$(detect_session)

  case "$session" in
    hyprland)
      hyprctl getoption input:kb_variant -j 2>/dev/null | jq -r '.str' || echo ""
      ;;
    wayland | i3 | x11)
      setxkbmap -query 2>/dev/null | awk '/variant/{print $2}' || echo ""
      ;;
  esac
}

# Apply layout to current session
apply_layout() {
  local layout="$1"
  local variant="${2:-}"
  local session
  session=$(detect_session)

  case "$session" in
    hyprland)
      hyprctl keyword input:kb_layout "$layout" >/dev/null 2>&1
      if [[ -n $variant ]]; then
        hyprctl keyword input:kb_variant "$variant" >/dev/null 2>&1
      else
        hyprctl keyword input:kb_variant "" >/dev/null 2>&1
      fi
      ;;
    wayland | i3 | x11)
      if [[ -n $variant ]]; then
        setxkbmap "$layout" "$variant" 2>/dev/null
      else
        setxkbmap "$layout" 2>/dev/null
      fi
      ;;
  esac

  # Send notification
  local display_key="${layout}:${variant}"
  local display_text="${LAYOUT_NAMES[$display_key]:-$layout}"
  [[ -n $variant && -z ${LAYOUT_NAMES[$display_key]:-} ]] && display_text="$layout ($variant)"

  if command -v notify-send >/dev/null 2>&1; then
    notify-send -u low -i input-keyboard "Keyboard Layout" "Switched to $display_text"
  fi
}

# Toggle between layouts
toggle_layout() {
  local current_layout current_variant current_full
  current_layout=$(get_current_layout)
  current_variant=$(get_current_variant)
  current_full="${current_layout}:${current_variant}"

  # Find current index
  local current_index=-1
  for i in "${!PREFERRED_LAYOUTS[@]}"; do
    if [[ ${PREFERRED_LAYOUTS[$i]} == "$current_full" ]]; then
      current_index=$i
      break
    fi
  done

  # Get next layout
  local next_index=$(((current_index + 1) % ${#PREFERRED_LAYOUTS[@]}))
  local next_layout="${PREFERRED_LAYOUTS[$next_index]}"

  # Split layout:variant
  local layout variant
  IFS=':' read -r layout variant <<<"$next_layout"

  # Apply
  apply_layout "$layout" "$variant"
}

# Show current layout info
show_current() {
  local session current_layout current_variant
  session=$(detect_session)
  current_layout=$(get_current_layout)
  current_variant=$(get_current_variant)

  echo "Session: $session"
  echo "Layout: $current_layout"
  [[ -n $current_variant ]] && echo "Variant: $current_variant"

  local current_full="${current_layout}:${current_variant}"
  local display_text="${LAYOUT_NAMES[$current_full]:-$current_layout}"
  [[ -n $current_variant && -z ${LAYOUT_NAMES[$current_full]:-} ]] && display_text="$current_layout ($current_variant)"

  echo "Display: $display_text"
}

# Open keyboard settings GUI
open_settings() {
  if command -v dots-keyboard-settings >/dev/null 2>&1; then
    dots-keyboard-settings
  elif command -v lxqt-config-input >/dev/null 2>&1; then
    lxqt-config-input &
  else
    notify-send "Error" "No keyboard settings GUI available. Install lxqt-config-input."
    exit 1
  fi
}

# Main
main() {
  # Handle flags
  if [[ ${current:-no} == yes ]]; then
    show_current
    exit 0
  fi

  if [[ ${get:-no} == yes ]]; then
    get_current_layout
    exit 0
  fi

  if [[ ${settings:-no} == yes ]]; then
    open_settings
    exit 0
  fi

  # Default: toggle layout
  toggle_layout
}

main "$@"
