#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Brightness control using xbacklight, brightnessctl, blight, or xrandr
##
## Usage:
##   @script.name DISPLAY OP [STEP] [OPTIONS]
##
## Options:
##   -h, --help          Show this help
##       --temp          Adjust color temperature instead of brightness
##       --list          List all connected displays
##
## Arguments:
##   DISPLAY             Display name (use "*" for focused display)
##   OP                  Operation: +, -, or =
##   STEP                Step size or target value (default: 0.1 for +/-, 1.0 for =)
##
## Examples:
##   @script.name "*" + 0.1         # Increase brightness by 10%
##   @script.name "*" - 0.05        # Decrease brightness by 5%
##   @script.name eDP-1 = 0.8       # Set brightness to 80%
##   @script.name "*" + 0.1 --temp  # Increase color temperature
##   @script.name --list            # Show all displays

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

if ! command -v bc &>/dev/null; then
  echo "bc command could not be found, it's needed to run this script."
  exit
fi

get_display_info() {
  xrandr --verbose | grep -m 1 -w "$1 connected" -A8 | grep "$2" | cut -f2- -d: | tr -d ' '
}

# cribbed from redshift, https://github.com/jonls/redshift/blob/master/README-colorramp
GAMMA_VALS=('1.0:0.7:0.4' # 3000K
  '1.0:0.7:0.5'           # 3500K
  '1.0:0.8:0.6'           # 4000K
  '1.0:0.8:0.7'           # 4500K
  '1.0:0.9:0.8'           # 5000K
  '1.0:0.9:0.9'           # 6000K
  '1.0:1.0:1.0'           # 6500K
  '0.9:0.9:1.0'           # 7000K
  '0.8:0.9:1.0'           # 8000K
  '0.8:0.8:1.0'           # 9000K
  '0.7:0.8:1.0')          # 10000K

get_gamma_index() {
  for i in "${!GAMMA_VALS[@]}"; do
    [[ ${GAMMA_VALS[$i]} == "$1" ]] && echo "$i" && break
  done
}

get_temp_for_gamma() {
  gamma_index=$(get_gamma_index "$1")
  awk '{printf "%.1f", $1 / 10}' <<<"$gamma_index"
}

get_gamma_for_temp() {
  temp_index=$(awk '{printf "%d", $1 * 10}' <<<"$1")
  echo "${GAMMA_VALS[$temp_index]}"
}

# gamma values returned by xrandr --verbose are somehow inverted
# https://gitlab.freedesktop.org/xorg/app/xrandr/issues/33
# this function corrects this bug by reverting the calculation
invert_gamma() {
  inverted_red=$(cut -d: -f1 <<<"$1")
  inverted_green=$(cut -d: -f2 <<<"$1")
  inverted_blue=$(cut -d: -f3 <<<"$1")
  red=$(awk '{printf "%.1f", 1/$1}' <<<"$inverted_red" 2>/dev/null)
  green=$(awk '{printf "%.1f", 1/$1}' <<<"$inverted_green" 2>/dev/null)
  blue=$(awk '{printf "%.1f", 1/$1}' <<<"$inverted_blue" 2>/dev/null)
  echo "$red:$green:$blue"
}

get_gamma() {
  invert_gamma "$(get_display_info "$1" 'Gamma: ')"
}

get_brightness() {
  if type -p brightnessctl >/dev/null; then
    echo "$(brightnessctl -q get) / 100000" | bc -l | awk '{printf "%f\n", $0}'
  elif type -p blight >/dev/null; then
    echo "$(blight get) / 100000" | bc -l | awk '{printf "%f\n", $0}'
  elif type -p xbacklight >/dev/null; then
    echo "$(xbacklight -get -display "$1") / 100" | bc -l | awk '{printf "%f", $0}'
  else
    get_display_info "$1" 'Brightness: '
  fi
}

list_displays() {
  echo 'displays:'
  displist=''
  connected=$(xrandr | grep -w connected | cut -f1 -d' ')
  for display in $connected; do
    brightness=$(get_brightness "$display")
    gamma=$(get_gamma "$display")
    temp=$(get_temp_for_gamma "$gamma")
    displist+="$display brightness: $brightness gamma: $gamma temp: $temp"
    displist+=$'\n'
  done
  echo "$displist" | column -t | sed 's/^/  /'
}

exec_op() {
  if [ "$1" = '+' ]; then
    NEWVAL=$(echo "$3 + $2" | bc)
  elif [ "$1" = '-' ]; then
    NEWVAL=$(echo "$3 - $2" | bc)
  elif [ "$1" = '=' ]; then
    NEWVAL=$2
  fi
  if [ "$(echo "$NEWVAL < 0.0" | bc)" -eq 1 ]; then
    NEWVAL='0.0'
  fi
  if [ "$(echo "$NEWVAL > 1.0" | bc)" -eq 1 ]; then
    NEWVAL='1.0'
  fi
  echo "$NEWVAL"
}

# Handle --list flag
if [[ ${list:-no} == yes ]]; then
  list_displays
  exit 0
fi

# Parse positional arguments
if [[ $# -lt 2 ]]; then
  echo "Error: Missing arguments. Use --help for usage." >&2
  exit 1
fi

DISP="$1"
OP="$2"

if [ "${DISP}" = "*" ]; then
  # use focused monitor instead
  DISP="$(dots monitor)"
fi

if [[ ! $OP =~ ^[+\-=]$ ]]; then
  echo "Error: Operation must be +, -, or =" >&2
  exit 1
fi

# Get step/value (third positional arg or default)
if [[ $# -ge 3 && $3 =~ ^[0-9]+(.[0-9]+)?$ ]]; then
  OPVAL=$3
else
  if [[ $OP == '=' ]]; then
    if [[ ${temp:-no} == yes ]]; then
      OPVAL='0.6'
    else
      OPVAL='1.0'
    fi
  else
    OPVAL='0.1'
  fi
fi

CURRBRIGHT=$(get_brightness "$DISP")
echo "$CURRBRIGHT"
if [[ ! $CURRBRIGHT =~ ^[0-9]+.[0-9]+$ ]]; then
  echo "Error: Selected display $DISP has no brightness value!"
  echo
  list_displays
  exit 1
fi

CURRGAMMA=$(get_gamma "$DISP")
if [[ ! $CURRGAMMA =~ ^[0-9].[0-9]:[0-9].[0-9]:[0-9].[0-9]$ ]]; then
  echo "Error: Selected display $DISP has no gamma value!"
  echo
  list_displays
  exit 1
fi

NEWBRIGHT="$CURRBRIGHT"
NEWGAMMA="$CURRGAMMA"

if [[ ${temp:-no} == yes ]]; then
  CURRTEMP=$(get_temp_for_gamma "$CURRGAMMA")
  NEWTEMP=$(exec_op "$OP" "$OPVAL" "$CURRTEMP")
  NEWGAMMA=$(get_gamma_for_temp "$NEWTEMP")
else
  NEWBRIGHT=$(exec_op "$OP" "$OPVAL" "$CURRBRIGHT")
fi

if type -p brightnessctl >/dev/null; then
  NEWBRIGHT=$(echo "$NEWBRIGHT * 100000" | bc)
  brightnessctl -q set "$NEWBRIGHT"
elif type -p blight >/dev/null; then
  NEWBRIGHT=$(echo "$NEWBRIGHT * 100000" | bc)
  blight set "$NEWBRIGHT"
elif type -p xbacklight >/dev/null; then
  NEWBRIGHT=$(echo "$NEWBRIGHT * 100" | bc)
  xbacklight -display "$DISP" -set "$NEWBRIGHT"
else
  xrandr --output "$DISP" --brightness "$NEWBRIGHT" --gamma "$NEWGAMMA"
fi

if [[ ${temp:-no} == yes ]]; then
  xrandr --output "$DISP" --gamma "$NEWGAMMA"
fi
