#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Toggle the state of some applications
##
## Usage:
##   @script.name [OPTIONS]
##
## Options:
##   -h, --help         Show this help message
##   -v, --version      Display script version
##   -r, --redshift     Toggle redshift or daemon monitoring icon
##   -f, --caffeine     Toggle caffeine or daemon monitoring icon
##   -t, --toggle       Toggle the program off/on, without this flag a monitor process will be started
##       --bar          Toggle Quickshell bar
##       --launcher     Toggle Quickshell launcher
##       --dashboard    Toggle Quickshell dashboard
##       --sidebar      Toggle Quickshell sidebar
##       --session      Toggle Quickshell session menu
##       --utilities    Toggle Quickshell utilities panel

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

toggle_redshift() {
  local opt="${toggle:-0}"
  if ((opt == 1)); then
    if pidof redshift >/dev/null 2>&1 && [ "$(pidof redshift 2>/dev/null | wc -l)" -ne 0 ]; then
      pkill redshift || true
    else
      redshift &
    fi
    exit 0
  fi
  icon=""
  local temp=""
  while true; do
    if pidof redshift >/dev/null 2>&1 && [ "$(pidof redshift 2>/dev/null | wc -l)" -ne 0 ]; then
      temp=$(redshift -p 2>/dev/null | grep -o '[0-9].*K' 2>/dev/null | sed 's/K//g' || echo "")
    else
      temp=""
    fi
    if [ -z "${temp:-}" ]; then
      echo " $icon " # Greyed out (not running)
    elif [ "${temp}" -ge 5000 ]; then
      echo "%{F#8039A0} $icon " # Blue
    elif [ "${temp}" -ge 4000 ]; then
      echo "%{F#F203F0} $icon " # Yellow
    else
      echo "%{F#FF5B6C} $icon " # Orange
    fi
    sleep 2
  done
}

toggle_quickshell_component() {
  local component="$1"
  if ! pgrep -x quickshell >/dev/null 2>&1; then
    echo "Quickshell is not running" >&2
    exit 1
  fi
  dots-quickshell ipc "$component" toggle
  exit 0
}

toggle_caffeine() {
  local opt="${toggle:-0}"
  if ((opt == 1)); then
    if pidof caffeine >/dev/null 2>&1 && [ "$(pidof caffeine 2>/dev/null | wc -l)" -ne 0 ]; then
      killall caffeine || true
    else
      caffeine &
    fi
    exit 0
  fi
  on=""
  off=""
  while true; do
    if pidof caffeine >/dev/null 2>&1; then
      echo "%{F#0000FF}$on"
    else
      echo "%{F#FF0000}$off"
    fi
    sleep 2
  done
}

# Handle options
if [[ -n ${version:-} ]]; then
  echo "dots-toggle -- Version 0.5"
  exit 0
fi

if [[ -n ${bar:-} ]]; then
  toggle_quickshell_component bar
elif [[ -n ${launcher:-} ]]; then
  toggle_quickshell_component launcher
elif [[ -n ${dashboard:-} ]]; then
  toggle_quickshell_component dashboard
elif [[ -n ${sidebar:-} ]]; then
  toggle_quickshell_component sidebar
elif [[ -n ${session:-} ]]; then
  toggle_quickshell_component session
elif [[ -n ${utilities:-} ]]; then
  toggle_quickshell_component utilities
elif [[ -n ${redshift:-} ]]; then
  toggle_redshift
elif [[ -n ${caffeine:-} ]]; then
  toggle_caffeine
else
  echo "Error: No action specified. Use --bar, --launcher, --dashboard, --sidebar, --session, --utilities, --redshift, or --caffeine" >&2
  exit 1
fi
