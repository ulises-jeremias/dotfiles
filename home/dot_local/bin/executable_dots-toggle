#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Toggle the state of some applications
##
## Usage:
##   @script.name [OPTIONS]
##
## Options:
##   -h, --help         Show this help message
##   -v, --version      Display script version
##   -w, --waybar       Toggle the configured waybar session
##   -r, --redshift     Toggle redshift or daemon monitoring icon
##   -f, --caffeine     Toggle caffeine or daemon monitoring icon
##   -t, --toggle       Toggle the program off/on, without this flag a monitor process will be started

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

toggle_waybar() {
  local opt="${toggle:-0}"
  if ((opt == 1)); then
    if pgrep -x waybar >/dev/null 2>&1; then
      killall waybar || true
    else
      ~/.config/waybar/launch.sh &
    fi
    exit 0
  fi
  on=""
  off=""
  while true; do
    if pgrep -x waybar >/dev/null 2>&1; then
      echo "$on"
    else
      echo "%{F#888888}$off"
    fi
    sleep 2
  done
}

toggle_redshift() {
  local opt="${toggle:-0}"
  if ((opt == 1)); then
    if pidof redshift >/dev/null 2>&1 && [ "$(pidof redshift 2>/dev/null | wc -l)" -ne 0 ]; then
      pkill redshift || true
    else
      redshift &
    fi
    exit 0
  fi
  icon=""
  local temp=""
  while true; do
    if pidof redshift >/dev/null 2>&1 && [ "$(pidof redshift 2>/dev/null | wc -l)" -ne 0 ]; then
      temp=$(redshift -p 2>/dev/null | grep -o '[0-9].*K' 2>/dev/null | sed 's/K//g' || echo "")
    else
      temp=""
    fi
    if [ -z "${temp:-}" ]; then
      echo " $icon " # Greyed out (not running)
    elif [ "${temp}" -ge 5000 ]; then
      echo "%{F#8039A0} $icon " # Blue
    elif [ "${temp}" -ge 4000 ]; then
      echo "%{F#F203F0} $icon " # Yellow
    else
      echo "%{F#FF5B6C} $icon " # Orange
    fi
    sleep 2
  done
}

toggle_caffeine() {
  local opt="${toggle:-0}"
  if ((opt == 1)); then
    if pidof caffeine >/dev/null 2>&1 && [ "$(pidof caffeine 2>/dev/null | wc -l)" -ne 0 ]; then
      killall caffeine || true
    else
      caffeine &
    fi
    exit 0
  fi
  on=""
  off=""
  while true; do
    if pidof caffeine >/dev/null 2>&1; then
      echo "%{F#0000FF}$on"
    else
      echo "%{F#FF0000}$off"
    fi
    sleep 2
  done
}

# Handle options
if [[ -n ${version:-} ]]; then
  echo "dots-toggle -- Version 0.5"
  exit 0
fi

if [[ -n ${waybar:-} ]]; then
  toggle_waybar
elif [[ -n ${redshift:-} ]]; then
  toggle_redshift
elif [[ -n ${caffeine:-} ]]; then
  toggle_caffeine
else
  echo "Error: No action specified. Use --waybar, --redshift, or --caffeine" >&2
  exit 1
fi
