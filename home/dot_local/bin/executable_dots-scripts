#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
##     @script.name [SCRIPT_NAME] [OPTION] ARGUMENTS...
##
## Options:
##     -h, --help                            Show this help message.
##

set -euo pipefail

# if ~/.local/bin is not in the PATH, add it
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
  export PATH="$HOME/.local/bin:${PATH}"
fi

# if ~/bin is not in the PATH, add it
if [[ ":$PATH:" != *":$HOME/bin:"* ]]; then
  export PATH="$HOME/bin:${PATH}"
fi

# Add pyenv shims to PATH if pyenv is installed and shims exist and it's not already in the PATH
if [[ -d "${HOME}/.pyenv/shims" && ":$PATH:" != *":$HOME/.pyenv/shims:"* ]]; then
  export PATH="${HOME}/.pyenv/shims:${PATH}"
fi

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

# Include the dots-scripts.sh file to get the list of scripts
source ~/.local/lib/dots/dots-scripts.sh || exit

# Function to execute the command in a terminal
execute_command() {
  local script_name
  script_name=$(echo "$1" | cut -d ' ' -f 2 | cut -d ':' -f 1)
  local command="kitty --hold -e echo \"dots $script_name\""

  # Open kitty with the command
  eval "$command"
}

# Use Quickshell if running
if pgrep -x quickshell > /dev/null 2>&1; then
  dots-quickshell ipc launcher toggle
  exit 0
fi

# Create the menu with fuzzel/wofi
if command -v fuzzel >/dev/null 2>&1; then
  selected=$(printf '%s\n' "${scripts_list[@]}" | fuzzel --dmenu --prompt "Select Script> ")
elif command -v wofi >/dev/null 2>&1; then
  selected=$(printf '%s\n' "${scripts_list[@]}" | wofi --dmenu --prompt "Select Script" --insensitive)
else
  echo "No menu backend available (requires fuzzel or wofi)" >&2
  exit 1
fi

# If a script is selected, execute or display its command
if [ -n "$selected" ]; then
  execute_command "$selected"
fi
