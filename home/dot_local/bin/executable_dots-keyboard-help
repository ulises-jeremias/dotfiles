#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Interactive keyboard shortcuts help overlay for Hyprland
## Displays all available keybindings in a searchable picker
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Usage:
##     @script.name [OPTIONS]
##
## Options:
##     -h, --help              Show this help message
##         --category=CAT      Filter by category (apps|window|workspace|media|system)
##         --search=TERM       Search for specific keybinding

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

readonly KEYBINDINGS_FILE="${HOME}/.config/hypr/hyprland.conf.d/keybindings.conf"

if [[ ${DOTS_BYPASS_QUICKSHELL:-0} != 1 ]] && pgrep -x quickshell >/dev/null 2>&1; then
  dots-settings-gui --pane=system menu
  exit 0
fi
parse_keybindings() {
  awk '
    /^# =+ .* =+$/ {
      cat = $0
      gsub(/^# =+ /, "", cat)
      gsub(/ =+$/, "", cat)
      next
    }
    /^bind[em]* = / {
      line = $0
      sub(/^bind[em]* = /, "", line)
      n = split(line, a, /,/)
      if (n >= 3) {
        mods = a[1]
        key = a[2]
        action = substr(line, index(line, a[3]))
        gsub(/^ +| +$/, "", mods)
        gsub(/^ +| +$/, "", key)
        gsub(/^ +| +$/, "", action)
        gsub(/\$mainMod/, "SUPER", mods)
        gsub(/ +/, " + ", mods)
        if (cat != "") {
          printf("[%s] %s + %s -> %s\n", cat, mods, key, action)
        } else {
          printf("%s + %s -> %s\n", mods, key, action)
        }
      }
    }
  ' "$KEYBINDINGS_FILE"
}

show_help() {
  local content
  content="$(parse_keybindings)"
  if [[ -n ${search:-} ]]; then
    content="$(printf '%s\n' "$content" | awk -v s="${search,,}" 'tolower($0) ~ s')"
  fi
  if [[ -n ${category:-} ]]; then
    content="$(printf '%s\n' "$content" | awk -v c="${category,,}" 'tolower($0) ~ "\\[" c')"
  fi

  [[ -z ${content:-} ]] && {
    echo "[WARN] No keybindings found" >&2
    exit 1
  }

  printf '%s\n' "$content" | less
}

# Main function
main() {
  if [[ ! -f $KEYBINDINGS_FILE ]]; then
    echo "[ERROR] Keybindings configuration not found" >&2
    exit 1
  fi

  show_help
}

main "$@"
