#!/usr/bin/env bash

## dots-performance-mode: Select or view performance profiles
## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
## Usage:
##   @script.name [OPTIONS]
## Options:
##   -h, --help            Show help
##       --gui             Open auto-cpufreq GUI if available

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

GUI=${gui:-no}
if [[ ${DOTS_BYPASS_QUICKSHELL:-0} != 1 ]] && pgrep -x quickshell > /dev/null 2>&1; then
  dots-settings-gui --pane=system menu
  exit 0
fi

if [[ $GUI == yes ]]; then
  if command -v auto-cpufreq-gtk >/dev/null 2>&1; then
    exec auto-cpufreq-gtk
  elif command -v auto-cpufreq >/dev/null 2>&1; then
    notify-send "Performance" "auto-cpufreq-gtk missing; using CLI monitor" || true
    exec auto-cpufreq --monitor
  else
    notify-send "Performance" "auto-cpufreq tools not installed. Falling back to powerprofilesctl." || true
  fi
fi

if ! command -v powerprofilesctl >/dev/null 2>&1; then
  notify-send "Performance" "powerprofilesctl not installed" || true
  exit 1
fi

current=$(powerprofilesctl get)
profiles=$(powerprofilesctl list | awk '{print $1}')

menu=""
for p in $profiles; do
  if [[ $p == "$current" ]]; then
    menu+="âœ“ $p\n"
  else
    menu+="  $p\n"
  fi
done
menu=${menu%\n}

echo "Performance profiles:"
i=1
selected=""
for p in $profiles; do
  if [[ $p == "$current" ]]; then
    echo "$i) $p (current)"
  else
    echo "$i) $p"
  fi
  i=$((i + 1))
done
printf "Select profile [1-%d, empty to cancel]: " "$((i - 1))"
read -r idx || exit 1
[[ -z ${idx:-} ]] && exit 0
[[ "$idx" =~ ^[0-9]+$ ]] || exit 1
(( idx >= 1 && idx < i )) || exit 1
i=1
for p in $profiles; do
  if (( i == idx )); then
    selected="$p"
    break
  fi
  i=$((i + 1))
done

powerprofilesctl set "$selected"
notify-send "Performance Mode" "Set to $selected" -u low || true
