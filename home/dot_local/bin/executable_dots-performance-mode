#!/usr/bin/env bash

## dots-performance-mode: Select or view performance profiles
## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
## Usage:
##   @script.name [OPTIONS]
## Options:
##   -h, --help            Show help
##       --gui             Open auto-cpufreq GUI if available
##       --backend=NAME    Menu backend: fuzzel|wofi (auto chain if omitted)

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

GUI=${gui:-no}
BACKEND=${backend:-auto}

if pgrep -x quickshell > /dev/null 2>&1; then
  dots-quickshell ipc utilities toggle
  exit 0
fi

if [[ $GUI == yes ]]; then
  if command -v auto-cpufreq-gtk >/dev/null 2>&1; then
    exec auto-cpufreq-gtk
  elif command -v auto-cpufreq >/dev/null 2>&1; then
    notify-send "Performance" "auto-cpufreq-gtk missing; using CLI monitor" || true
    exec auto-cpufreq --monitor
  else
    notify-send "Performance" "auto-cpufreq tools not installed. Falling back to powerprofilesctl." || true
  fi
fi

if ! command -v powerprofilesctl >/dev/null 2>&1; then
  notify-send "Performance" "powerprofilesctl not installed" || true
  exit 1
fi

current=$(powerprofilesctl get)
profiles=$(powerprofilesctl list | awk '{print $1}')

menu=""
for p in $profiles; do
  if [[ $p == "$current" ]]; then
    menu+="✓ $p\n"
  else
    menu+="  $p\n"
  fi
done
menu=${menu%\n}

choose_menu() {
  case "$BACKEND" in
    fuzzel)
      command -v fuzzel >/dev/null 2>&1 || return 1
      echo -e "$menu" | fuzzel --prompt "Performance> "
      ;;
    wofi)
      command -v wofi >/dev/null 2>&1 || return 1
      echo -e "$menu" | wofi --dmenu --prompt "Performance> "
      ;;
    auto | *)
      if command -v fuzzel >/dev/null 2>&1; then
        echo -e "$menu" | fuzzel --prompt "Performance> "
        return
      fi
      if command -v wofi >/dev/null 2>&1; then
        echo -e "$menu" | wofi --dmenu --prompt "Performance> "
        return
      fi
      return 1
      ;;
  esac
}

selected=$(choose_menu || true)
[[ -z $selected ]] && exit 0
selected=${selected#✓ }
selected=${selected#  }

powerprofilesctl set "$selected"
notify-send "Performance Mode" "Set to $selected" -u low || true
