#!/usr/bin/env bash

## Copyright (C) 2019-2026 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Yazi Terminal File Manager — Smart launcher with Wayland integration
## Wraps yazi with directory sync, diagnostics, and environment setup.
##
## Usage:
##   @script.name [OPTIONS] [PATH]
##
## Options:
##   -h, --help           Show this help
##   -l, --last-dir       On exit, cd shell to last yazi directory
##   -s, --select=FILE    Open yazi with FILE selected
##       --cheatsheet     Show keybinding cheatsheet
##       --fix-previews   Diagnose and fix preview issues
##       --path=PATH      Path to open (default: current directory)
##
## Examples:
##   dots-yazi                          # Open yazi in current directory
##   dots-yazi --last-dir               # Open yazi, cd to last dir on exit
##   dots-yazi --select=~/file.txt      # Open yazi with file selected
##   dots-yazi --cheatsheet             # Show keybinding reference
##   dots-yazi --fix-previews           # Check preview dependencies

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly BOLD='\033[1m'
readonly NC='\033[0m'

show_cheatsheet() {
  cat <<'EOF'
╔══════════════════════════════════════════════════════════════════════════════════╗
║                          YAZI CHEATSHEET — HorneroConfig                      ║
╠══════════════════════════════════════════════════════════════════════════════════╣
║                                                                                ║
║  ─── NAVIGATION ─────────────────────────────────────────────────────────────  ║
║    h / ←         Go to parent directory                                        ║
║    l / → / Enter Enter directory or open file                                  ║
║    j / ↓ / k / ↑ Move down / up                                               ║
║    J / K         Page half-down / half-up                                      ║
║    H / L         Undo / Redo navigation                                        ║
║    ~             Go to home directory                                          ║
║    .             Toggle hidden files                                           ║
║                                                                                ║
║  ─── QUICK DIRS (g + key) ───────────────────────────────────────────────────  ║
║    gh Home    gp Projects    gd Downloads    gD Documents                      ║
║    gP Pics    gm Music       gv Videos       gc ~/.config                      ║
║    gl .local  gr Rices       gw Wallpapers   gb Scripts                        ║
║    gt /tmp                                                                     ║
║                                                                                ║
║  ─── FILE OPS ───────────────────────────────────────────────────────────────  ║
║    Space  Toggle select   v  Invert selection   V  Enter visual mode           ║
║    y  Copy (yank)   x  Cut   p  Paste   P  Paste (overwrite)                  ║
║    d  Trash    D D  Trash (safe delete)    D  Permanently delete               ║
║    a  Create file/dir (append / for dir)   r  Rename                           ║
║    yp/yd/yn  Yank path/dir/name to clipboard                                  ║
║                                                                                ║
║  ─── POWER ──────────────────────────────────────────────────────────────────  ║
║    f  Filter       /  Search        s  Shell command                           ║
║    z  Jump (zoxide)   Z  Jump (fzf)                                            ║
║    C  Compress selection          X  Extract archive                           ║
║    Alt-t  Open in Thunar          ?  Help                                      ║
║                                                                                ║
║  ─── SORTING (o + key) ─────────────────────────────────────────────────────   ║
║    os Size   on Name   om Modified   ot Type   oe Extension   or Reverse      ║
║                                                                                ║
║  ─── TABS ───────────────────────────────────────────────────────────────────  ║
║    t  New tab    T  Close tab   1-9 Switch tab   [ / ] Prev/Next tab          ║
║                                                                                ║
╚══════════════════════════════════════════════════════════════════════════════════╝
EOF
}

fix_previews() {
  echo -e "${BOLD}${CYAN}Yazi Preview Diagnostics${NC}"
  echo ""
  local issues=0

  check_dep() {
    local cmd="$1" pkg="$2" purpose="$3" required="${4:-optional}"
    if command -v "$cmd" >/dev/null 2>&1; then
      echo -e "  ${GREEN}+${NC} $cmd — $purpose"
    else
      if [[ "$required" == "required" ]]; then
        echo -e "  ${RED}x${NC} $cmd — $purpose ${RED}(REQUIRED — install: $pkg)${NC}"
        ((issues++))
      else
        echo -e "  ${YELLOW}o${NC} $cmd — $purpose ${YELLOW}(optional — install: $pkg)${NC}"
      fi
    fi
  }

  echo -e "${BOLD}Core:${NC}"
  check_dep yazi "yazi" "File manager" required
  check_dep file "file" "MIME detection" required

  echo ""
  echo -e "${BOLD}Terminal:${NC}"
  if [[ "$TERM" == "xterm-kitty" ]] || [[ -n "${KITTY_PID:-}" ]]; then
    echo -e "  ${GREEN}+${NC} Running in Kitty terminal (native image protocol)"
  else
    echo -e "  ${YELLOW}o${NC} Not running in Kitty — image previews may be limited"
  fi

  echo ""
  echo -e "${BOLD}Preview tools:${NC}"
  check_dep bat                 "bat"                 "Syntax highlighting"        optional
  check_dep pdftoppm            "poppler"             "PDF previews"               optional
  check_dep ffmpegthumbnailer   "ffmpegthumbnailer"   "Video thumbnails"           optional
  check_dep mediainfo           "mediainfo"           "Media file info"            optional
  check_dep 7z                  "p7zip"               "Archive listing"            optional
  check_dep exiftool            "perl-image-exiftool" "EXIF metadata"              optional
  check_dep glow                "glow (AUR)"          "Markdown rendering"         optional
  check_dep jq                  "jq"                  "JSON formatting"            optional
  check_dep rsvg-convert        "librsvg"             "SVG conversion"             optional
  check_dep magick              "imagemagick"         "Image conversion"           optional

  echo ""
  echo -e "${BOLD}Power features:${NC}"
  check_dep fzf         "fzf"             "Fuzzy search (Z key)"             optional
  check_dep rg          "ripgrep"         "Content search"                   optional
  check_dep fd          "fd"              "Fast file finder"                 optional
  check_dep trash-put   "trash-cli"       "Safe delete (DD)"                 optional
  check_dep wl-copy     "wl-clipboard"    "Wayland clipboard (yp/yd/yn)"    optional
  check_dep zoxide      "zoxide"          "Smart directory jumps (z key)"    optional

  echo ""
  if [[ $issues -gt 0 ]]; then
    echo -e "${RED}Found $issues required issues. Fix them for best experience.${NC}"
    echo -e "Quick fix: ${BOLD}sudo pacman -S yazi${NC}"
  else
    echo -e "${GREEN}All required dependencies are installed!${NC}"
  fi
}

launch_yazi() {
  local target="${path:-${1:-$(pwd)}}"
  local yazi_args=()

  if [[ -n "${select:-}" ]]; then
    yazi_args+=("--chooser-file=/dev/null" "$select")
  elif [[ -d "$target" ]]; then
    yazi_args+=("$target")
  elif [[ -f "$target" ]]; then
    yazi_args+=("$(dirname "$target")")
  fi

  if [[ "${last_dir:-}" == "yes" ]]; then
    local tmp
    tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
    yazi --cwd-file="$tmp" "${yazi_args[@]}"
    if [[ -f "$tmp" ]]; then
      local chosen_dir
      chosen_dir="$(cat "$tmp")"
      rm -f "$tmp"
      if [[ -n "$chosen_dir" ]] && [[ "$chosen_dir" != "$(pwd)" ]]; then
        echo "$chosen_dir"
      fi
    fi
  else
    yazi "${yazi_args[@]}"
  fi
}

main() {
  if [[ "${help:-}" == "yes" ]]; then
    show_help
    exit 0
  fi

  if [[ "${cheatsheet:-}" == "yes" ]]; then
    show_cheatsheet
    exit 0
  fi

  if [[ "${fix_previews:-}" == "yes" ]]; then
    fix_previews
    exit 0
  fi

  launch_yazi "$@"
}

main "$@"
