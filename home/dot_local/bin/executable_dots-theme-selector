#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Program: dots-theme-selector
## Description: GTK theme selector for Quickshell-first setup
##
## Usage: dots-theme-selector [OPTIONS]
##
## Options:
##   -h, --help          Show this help message
##
## Examples:
##   dots-theme-selector             # Launch theme selector (terminal picker)
##
## Notes:
##   Scans ~/.themes and /usr/share/themes for available themes

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

if pgrep -x quickshell >/dev/null 2>&1; then
  exec ~/.local/bin/dots-settings-gui --pane=appearance menu
fi

# Minimal list-based selector for GTK theme
THEMES=$( (
  ls -1 ~/.themes 2>/dev/null
  ls -1 /usr/share/themes 2>/dev/null
) | sort -u) || true
if [[ -z ${THEMES} ]]; then
  notify-send "Themes" "No themes found in ~/.themes or /usr/share/themes"
  exit 1
fi

mapfile -t THEME_LIST < <(printf '%s\n' "$THEMES" | awk 'NF')
[[ ${#THEME_LIST[@]} -eq 0 ]] && exit 1
echo "GTK themes:"
i=1
for t in "${THEME_LIST[@]}"; do
  printf "%2d) %s\n" "$i" "$t"
  i=$((i + 1))
done
printf "Select theme [1-%d, empty to cancel]: " "${#THEME_LIST[@]}"
read -r idx || exit 1
[[ -z ${idx:-} ]] && exit 0
[[ "$idx" =~ ^[0-9]+$ ]] || exit 1
(( idx >= 1 && idx <= ${#THEME_LIST[@]} )) || exit 1
SELECTED="${THEME_LIST[$((idx - 1))]}"
[[ -z $SELECTED ]] && exit 0

gsettings set org.gnome.desktop.interface gtk-theme "$SELECTED" || {
  notify-send "Theme" "Failed to apply $SELECTED"
  exit 1
}
notify-send "Theme" "Applied $SELECTED"
