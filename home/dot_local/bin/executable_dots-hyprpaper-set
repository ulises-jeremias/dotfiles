#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Set wallpaper using hyprpaper for Hyprland
## This script updates hyprpaper configuration and reloads it

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

show_error() {
  echo -e "${RED}âŒ${NC} $1" >&2
}

show_success() {
  echo -e "${GREEN}âœ…${NC} $1"
}

show_status() {
  echo -e "${CYAN}ðŸŽ¨${NC} $1"
}

# Get wallpaper path from arguments or auto-detect
WALLPAPER_PATH=""

if [[ $# -eq 1 ]]; then
  WALLPAPER_PATH="$1"
else
  # Auto-detect from wpg or wal
  if [[ -L "$HOME/.config/wpg/.current" ]] || [[ -f "$HOME/.config/wpg/.current" ]]; then
    # .current is typically a symlink, resolve it
    WALLPAPER_PATH=$(readlink -f "$HOME/.config/wpg/.current" 2>/dev/null || echo "")
  fi

  if [[ -z $WALLPAPER_PATH ]] && { [[ -L "$HOME/.cache/wal/wal" ]] || [[ -f "$HOME/.cache/wal/wal" ]]; }; then
    # wal is also a symlink
    WALLPAPER_PATH=$(readlink -f "$HOME/.cache/wal/wal" 2>/dev/null || echo "")
  fi

  if [[ -z $WALLPAPER_PATH ]]; then
    show_error "No wallpaper path provided and could not auto-detect"
    echo "Usage: $0 [wallpaper_path]"
    exit 1
  fi
fi

# Validate wallpaper exists
if [[ ! -f $WALLPAPER_PATH ]]; then
  show_error "Wallpaper file not found: $WALLPAPER_PATH"
  exit 1
fi

show_status "Setting wallpaper: $WALLPAPER_PATH"

# Function to start/restart hyprpaper
start_hyprpaper() {
  pkill -x hyprpaper 2>/dev/null || true
  sleep 0.5
  hyprpaper &
  disown

  # Wait for hyprpaper to be ready
  local max_retries=20
  local retry_count=0
  while [ $retry_count -lt $max_retries ]; do
    if pgrep -x hyprpaper >/dev/null && \
       hyprctl hyprpaper wallpaper ", $WALLPAPER_PATH, cover" 2>/dev/null; then
      return 0
    fi
    sleep 0.5
    retry_count=$((retry_count + 1))
  done
  return 1
}

# Function to set wallpaper via IPC
set_wallpaper_ipc() {
  # Hyprpaper 0.8+ syntax: hyprctl hyprpaper wallpaper '[mon], [path], [fit_mode]'
  # Empty monitor = applies to all monitors
  if hyprctl hyprpaper wallpaper ", $WALLPAPER_PATH, cover" 2>/dev/null; then
    return 0
  fi
  # Fallback: try without fit_mode
  if hyprctl hyprpaper wallpaper ", $WALLPAPER_PATH" 2>/dev/null; then
    return 0
  fi
  return 1
}

# Check hyprctl is available
if ! command -v hyprctl >/dev/null 2>&1; then
  show_error "hyprctl not found - are you running Hyprland?"
  exit 1
fi

# Try to set wallpaper, restart hyprpaper if IPC fails
if pgrep -x hyprpaper >/dev/null; then
  if set_wallpaper_ipc; then
    show_success "Wallpaper set successfully"
    exit 0
  else
    show_status "IPC failed, restarting hyprpaper..."
    if start_hyprpaper; then
      show_success "Wallpaper set successfully (after restart)"
      exit 0
    fi
  fi
else
  show_status "Starting hyprpaper..."
  if start_hyprpaper; then
    show_success "Wallpaper set successfully"
    exit 0
  fi
fi

show_error "Failed to set wallpaper"
show_status "Hint: Check if IPC is enabled in hyprpaper.conf (ipc = on)"
exit 1
