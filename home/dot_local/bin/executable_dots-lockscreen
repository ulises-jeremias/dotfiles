#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Wayland lockscreen management with hyprlock
## Alternative to betterlockscreen for Wayland/Hyprland
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Usage:
##     @script.name [OPTION] ARGUMENTS...
##
## Options:
##         --update=PATH             Update lockscreen images from wallpaper
##     -l, --lock                    Lock screen with blur effect
##         --lock-effect=EFFECT      Lock screen with specific effect (dim, blur, dimblur, pixel)
##     -w, --wall                    Set wallpaper (uses dots-hyprpaper-set)
##         --wall-effect=EFFECT      Set wallpaper with specific effect
##         --dim=LEVEL               Dim level (0-100, default: 40)
##         --blur=LEVEL              Blur level (1-10, default: 5)
##         --pixel=SCALE             Pixel scale (default: 10)
##     -h, --help                    Show this help message
##     -v, --version                 Display script version

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

VER="1.0.0"

# Configuration
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/dots-lockscreen"
CURRENT_DIR="$CACHE_DIR/current"
CURRENT_WALLPAPER="$HOME/.cache/current_wallpaper"

# Default values from options
DIM_LEVEL="${dim:-40}"
BLUR_LEVEL="${blur:-5}"
PIXEL_SCALE="${pixel:-10}"

# Lock screen images
LOCK_RESIZE="$CURRENT_DIR/lock_resize.png"
LOCK_DIM="$CURRENT_DIR/lock_dim.png"
LOCK_BLUR="$CURRENT_DIR/lock_blur.png"
LOCK_DIMBLUR="$CURRENT_DIR/lock_dimblur.png"
LOCK_PIXEL="$CURRENT_DIR/lock_pixel.png"

# Smart colors cache
SMART_COLORS_CACHE="${HOME}/.cache/dots/smart-colors/current.env"

# Rice configuration
RICE_CONFIG_DIR="${HOME}/.local/share/dots/rices"
CURRENT_RICE_FILE="${HOME}/.local/share/dots/rices/.current_rice"

# Logging functions
log_info() {
  echo -e "\033[1;34m[INFO]\033[0m $*"
}

log_success() {
  echo -e "\033[1;32m[SUCCESS]\033[0m $*"
}

log_error() {
  echo -e "\033[1;31m[ERROR]\033[0m $*" >&2
}

log_warning() {
  echo -e "\033[1;33m[WARNING]\033[0m $*"
}

# Check dependencies
check_dependencies() {
  local missing_deps=()

  if ! command -v hyprlock >/dev/null 2>&1; then
    missing_deps+=("hyprlock")
  fi

  if ! command -v convert >/dev/null 2>&1 && ! command -v magick >/dev/null 2>&1; then
    missing_deps+=("imagemagick")
  fi

  if [[ ${#missing_deps[@]} -gt 0 ]]; then
    log_error "Missing dependencies: ${missing_deps[*]}"
    return 1
  fi

  return 0
}

# Get convert command (ImageMagick)
get_convert_cmd() {
  if command -v magick >/dev/null 2>&1; then
    echo "magick"
  else
    echo "convert"
  fi
}

# Run ImageMagick command
run_magick() {
  local convert_cmd
  convert_cmd=$(get_convert_cmd)

  if [[ $convert_cmd == "magick" ]]; then
    magick "$@"
  else
    convert "$@"
  fi
}

# Load smart colors
load_smart_colors() {
  if [[ -f $SMART_COLORS_CACHE ]]; then
    # shellcheck source=/dev/null
    source "$SMART_COLORS_CACHE"
  else
    # Fallback colors
    SMART_BG="${SMART_BG:-#1e1e1e}"
    SMART_FG="${SMART_FG:-#ffffff}"
    SMART_PRIMARY="${SMART_PRIMARY:-#6495ed}"
    SMART_ACCENT="${SMART_ACCENT:-#ff6b6b}"
    SMART_SUCCESS="${SMART_SUCCESS:-#51cf66}"
    SMART_WARNING="${SMART_WARNING:-#ffd43b}"
    SMART_ERROR="${SMART_ERROR:-#ff6b6b}"
  fi
}

# Get current rice style
get_rice_style() {
  local rice_style="default"

  # Try to get current rice name
  if [[ -f $CURRENT_RICE_FILE ]]; then
    local rice_name
    rice_name=$(cat "$CURRENT_RICE_FILE")
    local rice_config="$RICE_CONFIG_DIR/$rice_name/config.sh"

    if [[ -f $rice_config ]]; then
      # Extract RICE_STYLE from config
      local style
      style=$(grep -E "^RICE_STYLE=" "$rice_config" 2>/dev/null | cut -d'"' -f2)
      [[ -n $style ]] && rice_style="$style"
    fi
  fi

  echo "$rice_style"
}

# Get layout config based on rice style
get_layout_config() {
  local style="$1"
  local style_lower
  style_lower=$(echo "$style" | tr '[:upper:]' '[:lower:]')

  # Determine layout based on aesthetic category
  case "$style_lower" in
    *cyberpunk* | *neon* | *synthwave*)
      echo "cyberpunk"
      ;;
    *cozy* | *kawaii* | *pastel* | *soft*)
      echo "cozy"
      ;;
    *vaporwave* | *retro* | *80s* | *90s*)
      echo "vaporwave"
      ;;
    *minimal* | *clean*)
      echo "minimal"
      ;;
    *)
      echo "default"
      ;;
  esac
}

# Create effect images
create_resize_image() {
  local input="$1"
  local output="$2"
  local convert_cmd
  convert_cmd=$(get_convert_cmd)

  log_info "Creating base resized image..."
  # Get screen resolution
  local resolution
  if [[ -n ${WAYLAND_DISPLAY:-} ]] && command -v swaymsg >/dev/null 2>&1; then
    resolution=$(swaymsg -t get_outputs 2>/dev/null | jq -r '.[0] | "\(.current_mode.width)x\(.current_mode.height)"' 2>/dev/null || echo "1920x1080")
  elif command -v xrandr >/dev/null 2>&1; then
    resolution=$(xrandr --current | grep '\*' | uniq | awk '{print $1}' | head -n1)
    [[ -z $resolution ]] && resolution="1920x1080"
  else
    resolution="1920x1080"
  fi

  # Use magick directly to avoid deprecation warnings
  run_magick "$input" -resize "${resolution}^" -gravity center -extent "${resolution}" "$output"
}

create_dim_image() {
  local input="$1"
  local output="$2"
  local level="$3"

  log_info "Creating dimmed image (level: $level)..."
  run_magick "$input" -fill black -colorize "${level}%" "$output"
}

create_blur_image() {
  local input="$1"
  local output="$2"
  local level="$3"

  log_info "Creating blurred image (level: $level)..."
  run_magick "$input" -blur "0x${level}" "$output"
}

create_dimblur_image() {
  local input="$1"
  local output="$2"
  local dim_level="$3"
  local blur_level="$4"

  log_info "Creating dim+blur image..."
  run_magick "$input" -fill black -colorize "${dim_level}%" -blur "0x${blur_level}" "$output"
}

create_pixel_image() {
  local input="$1"
  local output="$2"
  local scale="$3"

  log_info "Creating pixelated image (scale: $scale)..."
  local width height
  width=$(run_magick "$input" -format "%w" info:)
  height=$(run_magick "$input" -format "%h" info:)

  local new_width=$((width / scale))
  local new_height=$((height / scale))

  run_magick "$input" -scale "${new_width}x${new_height}" -scale "${width}x${height}" "$output"
}

# Update lockscreen images
update_lockscreen() {
  local wallpaper="$1"

  if [[ ! -f $wallpaper ]]; then
    log_error "Wallpaper file not found: $wallpaper"
    return 1
  fi

  log_info "Updating lockscreen images from: $wallpaper"

  # Create cache directory
  mkdir -p "$CURRENT_DIR"

  # Create base resized image
  create_resize_image "$wallpaper" "$LOCK_RESIZE"

  # Create effect images
  create_dim_image "$LOCK_RESIZE" "$LOCK_DIM" "$DIM_LEVEL"
  create_blur_image "$LOCK_RESIZE" "$LOCK_BLUR" "$BLUR_LEVEL"
  create_dimblur_image "$LOCK_RESIZE" "$LOCK_DIMBLUR" "$DIM_LEVEL" "$BLUR_LEVEL"
  create_pixel_image "$LOCK_RESIZE" "$LOCK_PIXEL" "$PIXEL_SCALE"

  log_success "Lockscreen images updated successfully"
}

# Generate cyberpunk layout config
generate_cyberpunk_config() {
  local image="$1"
  local bg_color="$2"
  local fg_color="$3"
  local primary_color="$4"
  local error_color="$5"

  cat <<EOF
# Generated by dots-lockscreen - Cyberpunk Layout
background {
  monitor =
  path = $image
  blur_passes = 4
  blur_size = 8
  contrast = 1.1
  brightness = 0.6
  vibrancy = 0.3
  vibrancy_darkness = 0.2
}

input-field {
  monitor =
  size = 350, 55
  outline_thickness = 3
  dots_size = 0.25
  dots_spacing = 0.4
  dots_center = true
  dots_rounding = 2
  outer_color = rgba(ff00ffff)
  inner_color = rgba(0a0a0fcc)
  font_color = rgba(00ffffff)
  fade_on_empty = true
  fade_timeout = 500
  placeholder_text = <i>// ENTER ACCESS CODE...</i>
  hide_input = false
  rounding = 5
  check_color = rgba(00ffffff)
  fail_color = rgba(ff0064ff)
  fail_text = <i>ACCESS DENIED [\$ATTEMPTS]</i>
  fail_transition = 200
  position = 0, -100
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%H:%M:%S')"
  color = rgba(00ffffff)
  font_size = 90
  font_family = JetBrainsMono Nerd Font
  text_align = center
  position = 0, 180
  halign = center
  valign = center
  shadow_passes = 3
  shadow_size = 10
  shadow_color = rgba(00ffff66)
}

label {
  monitor =
  text = ‚ñåSYSTEM LOCKED‚ñê
  color = rgba(ff00ffdd)
  font_size = 14
  font_family = JetBrainsMono Nerd Font
  position = 0, 100
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%Y.%m.%d')"
  color = rgba(9d00ffdd)
  font_size = 16
  font_family = JetBrainsMono Nerd Font
  position = 0, 70
  halign = center
  valign = center
}

label {
  monitor =
  text = Û∞ØÑ \$USER
  color = rgba(ff00ffcc)
  font_size = 18
  font_family = JetBrainsMono Nerd Font
  position = 0, -170
  halign = center
  valign = center
}
EOF
}

# Generate cozy layout config
generate_cozy_config() {
  local image="$1"
  local bg_color="$2"
  local fg_color="$3"
  local primary_color="$4"
  local error_color="$5"

  cat <<EOF
# Generated by dots-lockscreen - Cozy Layout
background {
  monitor =
  path = $image
  blur_passes = 2
  blur_size = 5
  contrast = 0.95
  brightness = 0.9
  vibrancy = 0.1
  vibrancy_darkness = 0.0
}

input-field {
  monitor =
  size = 280, 50
  outline_thickness = 2
  dots_size = 0.35
  dots_spacing = 0.35
  dots_center = true
  dots_rounding = -1
  outer_color = rgba(f5c2e7aa)
  inner_color = rgba(1e1e2ecc)
  font_color = rgba(f5e0dcff)
  fade_on_empty = true
  fade_timeout = 2000
  placeholder_text = <i>password...</i>
  hide_input = false
  rounding = 16
  check_color = rgba(a6e3a1ff)
  fail_color = rgba(f38ba8ff)
  fail_text = <i>oops! try again~</i>
  fail_transition = 500
  position = 0, -100
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%-I:%M %p')"
  color = rgba(f5e0dcff)
  font_size = 70
  font_family = Quicksand
  position = 0, 160
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%A')"
  color = rgba(cba6f7dd)
  font_size = 22
  font_family = Quicksand
  position = 0, 90
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%B %d, %Y')"
  color = rgba(f5c2e7cc)
  font_size = 16
  font_family = Quicksand
  position = 0, 60
  halign = center
  valign = center
}

label {
  monitor =
  text = üå∏ \$USER
  color = rgba(f5c2e7dd)
  font_size = 16
  font_family = Quicksand
  position = 0, -165
  halign = center
  valign = center
}
EOF
}

# Generate vaporwave layout config
generate_vaporwave_config() {
  local image="$1"
  local bg_color="$2"
  local fg_color="$3"
  local primary_color="$4"
  local error_color="$5"

  cat <<EOF
# Generated by dots-lockscreen - Vaporwave Layout
background {
  monitor =
  path = $image
  blur_passes = 2
  blur_size = 6
  contrast = 1.0
  brightness = 0.75
  vibrancy = 0.25
  vibrancy_darkness = 0.1
}

input-field {
  monitor =
  size = 320, 50
  outline_thickness = 2
  dots_size = 0.3
  dots_spacing = 0.35
  dots_center = true
  dots_rounding = 0
  outer_color = rgba(ff71ceff)
  inner_color = rgba(1a0a2ecc)
  font_color = rgba(01cdfeff)
  fade_on_empty = true
  fade_timeout = 1000
  placeholder_text = <i>‚ñåPASSWORD‚ñê</i>
  hide_input = false
  rounding = 0
  check_color = rgba(05ffa1ff)
  fail_color = rgba(ff71ceff)
  fail_text = <i>‚ñåERROR‚ñê</i>
  fail_transition = 300
  position = 0, -100
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%H:%M:%S')"
  color = rgba(01cdfeff)
  font_size = 75
  font_family = VCR OSD Mono
  position = 0, 170
  halign = center
  valign = center
}

label {
  monitor =
  text = Ôº∂Ôº°Ôº∞ÔºØÔº≤ÔΩóÔΩÅÔΩñÔΩÖ
  color = rgba(ff71cedd)
  font_size = 20
  font_family = VCR OSD Mono
  position = 0, 95
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%m / %d / %y')"
  color = rgba(b967ffcc)
  font_size = 16
  font_family = VCR OSD Mono
  position = 0, 65
  halign = center
  valign = center
}

label {
  monitor =
  text = üå¥ \$USER üå¥
  color = rgba(05ffa1cc)
  font_size = 16
  font_family = VCR OSD Mono
  position = 0, -165
  halign = center
  valign = center
}
EOF
}

# Generate minimal layout config
generate_minimal_config() {
  local image="$1"
  local bg_color="$2"
  local fg_color="$3"
  local primary_color="$4"
  local error_color="$5"

  cat <<EOF
# Generated by dots-lockscreen - Minimal Layout
background {
  monitor =
  path = $image
  blur_passes = 3
  blur_size = 8
  contrast = 0.9
  brightness = 0.85
  vibrancy = 0.0
  vibrancy_darkness = 0.0
}

input-field {
  monitor =
  size = 250, 45
  outline_thickness = 1
  dots_size = 0.3
  dots_spacing = 0.3
  dots_center = true
  dots_rounding = -1
  outer_color = rgba(${primary_color}88)
  inner_color = rgba(${bg_color}cc)
  font_color = rgba(${fg_color}ff)
  fade_on_empty = true
  fade_timeout = 1500
  placeholder_text =
  hide_input = false
  rounding = 8
  check_color = rgba(${primary_color}ff)
  fail_color = rgba(${error_color}ff)
  fail_text =
  fail_transition = 200
  position = 0, 0
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%H:%M')"
  color = rgba(${fg_color}ff)
  font_size = 64
  font_family = SF Pro Display
  position = 0, 150
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%a, %b %d')"
  color = rgba(${fg_color}aa)
  font_size = 16
  font_family = SF Pro Display
  position = 0, 90
  halign = center
  valign = center
}
EOF
}

# Generate default layout config
generate_default_config() {
  local image="$1"
  local bg_color="$2"
  local fg_color="$3"
  local primary_color="$4"
  local error_color="$5"

  cat <<EOF
# Generated by dots-lockscreen - Default Layout
background {
  monitor =
  path = $image
  blur_passes = 3
  blur_size = 7
  contrast = 0.8916
  brightness = 0.8172
  vibrancy = 0.1696
  vibrancy_darkness = 0.0
}

input-field {
  monitor =
  size = 300, 60
  outline_thickness = 2
  dots_size = 0.33
  dots_spacing = 0.3
  dots_center = true
  dots_rounding = -1
  outer_color = rgba(${primary_color}ff)
  inner_color = rgba(${bg_color}cc)
  font_color = rgba(${fg_color}ff)
  fade_on_empty = true
  fade_timeout = 1000
  placeholder_text = <i>Enter Password...</i>
  hide_input = false
  rounding = -1
  check_color = rgba(${primary_color}ff)
  fail_color = rgba(${error_color}ff)
  fail_text = <i>\$FAIL <b>(\$ATTEMPTS)</b></i>
  fail_transition = 300
  capslock_color = -1
  numlock_color = -1
  bothlock_color = -1
  invert_numlock = false
  swap_font_color = false
  position = 0, -120
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%H:%M')"
  color = rgba(${fg_color}ff)
  font_size = 80
  font_family = JetBrainsMono Nerd Font
  position = 0, 150
  halign = center
  valign = center
}

label {
  monitor =
  text = cmd[update:1000] echo "\$(date +'%A, %d %B %Y')"
  color = rgba(${fg_color}dd)
  font_size = 18
  font_family = JetBrainsMono Nerd Font
  position = 0, 80
  halign = center
  valign = center
}

label {
  monitor =
  text = Û∞åæ \$USER
  color = rgba(${fg_color}dd)
  font_size = 16
  font_family = JetBrainsMono Nerd Font
  position = 0, -180
  halign = center
  valign = center
}
EOF
}

# Lock screen with hyprlock
lock_screen() {
  local effect="${1:-blur}"
  local image=""

  load_smart_colors

  # Select image based on effect
  case "$effect" in
    dim)
      image="$LOCK_DIM"
      ;;
    blur)
      image="$LOCK_BLUR"
      ;;
    dimblur)
      image="$LOCK_DIMBLUR"
      ;;
    pixel)
      image="$LOCK_PIXEL"
      ;;
    *)
      image="$LOCK_BLUR"
      ;;
  esac

  # Fallback to resize if effect image doesn't exist
  if [[ ! -f $image ]]; then
    log_warning "Effect image not found, using base image"
    image="$LOCK_RESIZE"
  fi

  # Check if image exists
  if [[ ! -f $image ]]; then
    log_error "No lockscreen image available. Run: dots-lockscreen --update=<wallpaper>"
    return 1
  fi

  # Get rice style and layout
  local rice_style
  rice_style=$(get_rice_style)
  local layout
  layout=$(get_layout_config "$rice_style")

  log_info "Locking screen with effect: $effect, layout: $layout"
  log_info "Using image: $image"

  # Generate temporary hyprlock config with current wallpaper
  local temp_config="/tmp/hyprlock-$$.conf"

  # Remove # from color codes for hyprlock
  local bg_color="${SMART_BG#\#}"
  local fg_color="${SMART_FG#\#}"
  local primary_color="${SMART_PRIMARY#\#}"
  local error_color="${SMART_ERROR#\#}"

  # Generate layout-specific config
  case "$layout" in
    cyberpunk)
      generate_cyberpunk_config "$image" "$bg_color" "$fg_color" "$primary_color" "$error_color" >"$temp_config"
      ;;
    cozy)
      generate_cozy_config "$image" "$bg_color" "$fg_color" "$primary_color" "$error_color" >"$temp_config"
      ;;
    vaporwave)
      generate_vaporwave_config "$image" "$bg_color" "$fg_color" "$primary_color" "$error_color" >"$temp_config"
      ;;
    minimal)
      generate_minimal_config "$image" "$bg_color" "$fg_color" "$primary_color" "$error_color" >"$temp_config"
      ;;
    *)
      generate_default_config "$image" "$bg_color" "$fg_color" "$primary_color" "$error_color" >"$temp_config"
      ;;
  esac

  # Lock with hyprlock using temporary config
  hyprlock --config "$temp_config"

  # Clean up temporary config
  rm -f "$temp_config"
}

# Main function
main() {
  # Handle version flag
  if [[ ${version:-} == "yes" ]]; then
    echo "dots-lockscreen version $VER"
    exit 0
  fi

  # Check if running on Wayland
  if [[ -z ${WAYLAND_DISPLAY:-} ]]; then
    log_error "This script requires Wayland"
    exit 1
  fi

  # Check dependencies
  if ! check_dependencies; then
    exit 1
  fi

  # Determine action based on flags
  if [[ -n ${update:-} ]]; then
    # Update lockscreen images
    local wallpaper="$update"

    if [[ ! -f $wallpaper ]]; then
      # Try to get current wallpaper
      if [[ -f $CURRENT_WALLPAPER ]]; then
        wallpaper=$(cat "$CURRENT_WALLPAPER")
      else
        log_error "Wallpaper file not found: $wallpaper"
        exit 1
      fi
    fi

    update_lockscreen "$wallpaper"

  elif [[ ${lock:-} == "yes" ]] || [[ -n ${lock_effect:-} ]]; then
    # Lock screen
    local effect="${lock_effect:-blur}"
    lock_screen "$effect"

  elif [[ ${wall:-} == "yes" ]] || [[ -n ${wall_effect:-} ]]; then
    # Set wallpaper
    local effect="${wall_effect:-}"

    if command -v dots-hyprpaper-set >/dev/null 2>&1; then
      if [[ -n $effect ]]; then
        dots-hyprpaper-set "$effect"
      else
        dots-hyprpaper-set
      fi
    else
      log_warning "dots-hyprpaper-set not found, skipping wallpaper update"
    fi

  else
    log_error "No command specified. Use -h for help"
    exit 1
  fi
}

main "$@"
