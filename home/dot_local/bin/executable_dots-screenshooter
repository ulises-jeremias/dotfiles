#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Take a screenshot
##
## Usage:
##   @script.name [OPTIONS]
##
## Options:
##   -h, --help         Show this help message
##   -v, --version      Display script version
##   -f, --fullscreen   Take a screenshot of the entire screen
##   -r, --region       Select a region to capture interactively

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

set -euo pipefail

# Run flameshot with optimal settings for the current environment
run_flameshot() {
  local mode="$1"

  # Environment variables for flameshot
  local env_vars=()

  # Fix font rendering issues (QT6 changed default DPI rounding)
  env_vars+=("QT_SCALE_FACTOR_ROUNDING_POLICY=Round")

  if [[ -n ${WAYLAND_DISPLAY:-} ]]; then
    # Wayland native mode
    # Requires: xdg-desktop-portal, xdg-desktop-portal-hyprland (or wlr), grim
    # Multi-monitor fix via Hyprland window rules in hyprland.conf.d/window-rules.conf
    # Config tweaks in ~/.config/flameshot/flameshot.ini (useGrimAdapter=true)
    env_vars+=("QT_QPA_PLATFORM=wayland")

    if [[ "$mode" == "gui" ]]; then
      env "${env_vars[@]}" flameshot gui 2>/dev/null
    else
      env "${env_vars[@]}" flameshot full 2>/dev/null
    fi
  else
    # X11: Run flameshot normally
    if [[ "$mode" == "gui" ]]; then
      env "${env_vars[@]}" flameshot gui 2>/dev/null
    else
      env "${env_vars[@]}" flameshot full 2>/dev/null
    fi
  fi
}

shoot() {
  local pictures_dir
  pictures_dir=$(xdg-user-dir PICTURES 2>/dev/null || echo "$HOME/Pictures")
  local timestamp
  timestamp=$(date +%Y%m%d_%H%M%S)
  local filename="${pictures_dir}/screenshot_${timestamp}.png"

  # Priority 1: Flameshot - Best GUI with editing capabilities
  # Works on X11 natively and on Wayland via XWayland
  if type -p flameshot >/dev/null; then
    if [ -n "$region" ]; then
      run_flameshot gui
    else
      run_flameshot full
    fi
    return 0
  fi

  # Priority 2: Hyprland native (grimblast) - Best for Hyprland without flameshot
  if [[ -n ${HYPRLAND_INSTANCE_SIGNATURE:-} ]] && type -p grimblast >/dev/null; then
    if [ -n "$region" ]; then
      grimblast --notify copysave area "$filename"
    else
      grimblast --notify copysave screen "$filename"
    fi
    return 0
  fi

  # Priority 3: Wayland generic (grim + slurp) - Works well with multiple monitors
  if [[ -n ${WAYLAND_DISPLAY:-} ]] && type -p grim >/dev/null; then
    if [ -n "$region" ] && type -p slurp >/dev/null; then
      grim -g "$(slurp)" "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    else
      grim "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    fi
    return 0
  fi

  # Priority 4: XFCE4 screenshooter (fallback for X11)
  if type -p xfce4-screenshooter >/dev/null; then
    if [ -n "$region" ]; then
      xfce4-screenshooter -r
    else
      xfce4-screenshooter -f
    fi
    return 0
  fi

  # Priority 5: scrot (last resort for X11)
  if type -p scrot >/dev/null; then
    if [ -n "$region" ]; then
      scrot -s "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    else
      scrot "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    fi
    return 0
  fi

  # No screenshot tool found
  notify-send -u critical "Screenshot Error" "No screenshot tool available. Install flameshot, grimblast, grim, or scrot."
  return 1
}

# Handle options
if [[ -n "${version:-}" ]]; then
  echo "dots-screenshooter -- Version 0.3"
  exit 0
fi

# Execute screenshot
if [[ -n "${region:-}" ]]; then
  region=1
  shoot
else
  shoot
fi
