#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## Take a screenshot

NAME=$(basename "$0")
VER="0.1"

usage() {
  cat <<-EOF

 USAGE:  $NAME [OPTIONS [ADDITIONAL]]

 OPTIONS:

     -h,--help         Display this message

     -v,--version      Display script version

     -f,--fullscreen   Take a screenshot of the entire screen

     -r,--region       Select a region to be captured by clicking a point of the screen without releasing the mouse button, dragging your mouse to the other corner of the region, and releasing the mouse button.

EOF
}

shoot() {
  local pictures_dir
  pictures_dir=$(xdg-user-dir PICTURES 2>/dev/null || echo "$HOME/Pictures")
  local timestamp
  timestamp=$(date +%Y%m%d_%H%M%S)
  local filename="${pictures_dir}/screenshot_${timestamp}.png"

  # Priority 1: Hyprland native (grimblast) - Best for Hyprland
  if [[ -n ${HYPRLAND_INSTANCE_SIGNATURE:-} ]] && type -p grimblast >/dev/null; then
    if [ -n "$region" ]; then
      grimblast --notify copysave area "$filename"
    else
      grimblast --notify copysave screen "$filename"
    fi
    return 0
  fi

  # Priority 2: Wayland generic (grim + slurp) - Works well with multiple monitors
  if [[ -n ${WAYLAND_DISPLAY:-} ]] && type -p grim >/dev/null; then
    if [ -n "$region" ] && type -p slurp >/dev/null; then
      grim -g "$(slurp)" "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    else
      grim "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    fi
    return 0
  fi

  # Priority 3: Flameshot (GUI with editor, but has issues with Wayland multi-monitor)
  if type -p flameshot >/dev/null; then
    if [ -n "$region" ]; then
      flameshot gui
    else
      flameshot full
    fi
    return 0
  fi

  # Priority 4: XFCE4 screenshooter (fallback for X11)
  if type -p xfce4-screenshooter >/dev/null; then
    if [ -n "$region" ]; then
      xfce4-screenshooter -r
    else
      xfce4-screenshooter -f
    fi
    return 0
  fi

  # Priority 5: scrot (last resort for X11)
  if type -p scrot >/dev/null; then
    if [ -n "$region" ]; then
      scrot -s "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    else
      scrot "$filename" && notify-send -i "$filename" "Screenshot" "Saved to $filename"
    fi
    return 0
  fi

  # No screenshot tool found
  notify-send -u critical "Screenshot Error" "No screenshot tool available. Install grimblast, grim, or flameshot."
  return 1
}

# Catch command line options
case $1 in
  -h | --help) usage ;;
  -v | --version) echo -e "$NAME -- Version $VER" ;;
  -f | --fullscreen) shoot ;;
  -r | --redshift)
    region=1
    shoot
    ;;
  *) shoot ;;
esac
