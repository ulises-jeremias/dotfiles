#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
##     @script.name [SCRIPT_NAME] [OPTION] ARGUMENTS...
##
## Options:
##     -h, --help                            Show this help message.
##     -l, --list                            List all available scripts.
##

set -euo pipefail

show_message_with_usage() {
  [[ -z $documentation ]] && parse_documentation
  echo "$documentation"
  echo
  echo "$1"
  exit 1
}

# if ~/.local/bin is not in the PATH, add it
if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
  export PATH="$HOME/.local/bin:${PATH}"
fi

# if ~/bin is not in the PATH, add it
if [[ ":$PATH:" != *":$HOME/bin:"* ]]; then
  export PATH="$HOME/bin:${PATH}"
fi

NO_HELP=true
NO_CHECK=true
source ~/.local/lib/dots/easy-options/easyoptions.sh || exit

# Include the dots-scripts.sh file to get the list of scripts
source ~/.local/lib/dots/dots-scripts.sh || exit

is_valid_script() {
  local requested_script="$1"
  local script_entry script_name

  for script_entry in "${scripts_list[@]}"; do
    script_name=$(echo "${script_entry}" | cut -d ':' -f 1)
    if [[ $script_name == "$requested_script" ]]; then
      return 0
    fi
  done

  return 1
}

script="${arguments[0]:-}"

if [[ -n ${script} ]]; then
  if ! is_valid_script "$script"; then
    show_message_with_usage "Invalid script specified."
  fi

  LOCAL_BIN_DIR="${HOME}/.local/bin"

  if [[ ! -x "${LOCAL_BIN_DIR}/dots-${script}" ]]; then
    show_message_with_usage "Script not found: ${LOCAL_BIN_DIR}/dots-${script}"
  fi

  "${LOCAL_BIN_DIR}/dots-${script}" "${@:2}"
  exit $?
fi

if [[ -n ${list:-} ]]; then
  for script_entry in "${scripts_list[@]}"; do
    script_name_with_icon=$(echo "${script_entry}" | cut -d ':' -f 1)
    script_desc=$(echo "${script_entry}" | cut -d ':' -f 2)
    echo -e "$(tput setaf 3)${script_name_with_icon}$(tput sgr0)$(tput setaf 7)${script_desc}$(tput sgr0)"
  done
  exit
fi

if [[ -n ${help:-} ]]; then
  [[ -z $documentation ]] && parse_documentation
  echo "$documentation"
  exit
fi

show_message_with_usage "No script specified."
