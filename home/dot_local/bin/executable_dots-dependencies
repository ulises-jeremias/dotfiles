#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
##     @script.name [OPTION] ARGUMENTS...
##
## Options:
##     -h, --help                            Show this help message.
##     -c, --check                          Check missing dependencies.
##     -i, --install                        Install missing dependencies.
##     -l, --list                           List all dependencies.
##         --optional                       Include optional dependencies.
##

set -euo pipefail

source ~/.local/lib/dots/easy-options/easyoptions.sh || exit
source ~/.local/lib/dots/logging.sh || exit

# Core dependencies required for basic functionality
declare -A CORE_DEPS=(
  ["git"]="Version control system"
  ["curl"]="HTTP client for downloads"
  ["wget"]="HTTP client alternative"
  ["chezmoi"]="Dotfiles manager"
  ["zsh"]="Primary shell"
)

# Quickshell-first Wayland environment components (canonical stack)
declare -A WL_DEPS=(
  ["hyprland"]="Wayland compositor"
  ["quickshell"]="Desktop shell (bar/launcher/dashboard/control center)"
  ["hyprpaper"]="Wallpaper daemon"
  ["hyprlock"]="Lock screen"
  ["hypridle"]="Idle daemon"
  ["cliphist"]="Clipboard history"
)

# Development tools (optional)
declare -A DEV_DEPS=(
  ["kitty"]="Terminal emulator"
  ["nvim"]="Text editor"
  ["tmux"]="Terminal multiplexer"
  ["ranger"]="File manager"
  ["btop"]="System monitor"
  ["fastfetch"]="System info"
)

# Audio/Media dependencies (optional)
declare -A MEDIA_DEPS=(
  ["pipewire"]="Audio system"
  ["spotify"]="Music player"
  ["mpv"]="Video player"
  ["cava"]="Audio visualizer"
)

check_dependency() {
  local cmd="$1"
  local desc="$2"

  if command -v "$cmd" >/dev/null 2>&1; then
    log_info "$cmd - $desc (installed)"
    return 0
  else
    log_warn "$cmd - $desc (missing)"
    return 1
  fi
}

check_all_dependencies() {
  local missing=0

  log_info "Checking core dependencies..."
  for cmd in "${!CORE_DEPS[@]}"; do
    if ! check_dependency "$cmd" "${CORE_DEPS[$cmd]}"; then
      ((missing++))
    fi
  done

  log_info "Checking Wayland environment components..."
  for cmd in "${!WL_DEPS[@]}"; do
    if ! check_dependency "$cmd" "${WL_DEPS[$cmd]}"; then
      ((missing++))
    fi
  done

  if [[ -n ${optional} ]]; then
    log_info "Checking development dependencies..."
    for cmd in "${!DEV_DEPS[@]}"; do
      check_dependency "$cmd" "${DEV_DEPS[$cmd]}" || true
    done

    log_info "Checking media dependencies..."
    for cmd in "${!MEDIA_DEPS[@]}"; do
      check_dependency "$cmd" "${MEDIA_DEPS[$cmd]}" || true
    done
  fi

  if [[ $missing -gt 0 ]]; then
    log_warn "Found $missing missing core dependencies!"
    log_info "Run 'dots dependencies --install' to install them."
    return 1
  else
    log_info "All core dependencies are satisfied!"
    return 0
  fi
}

install_dependencies() {
  log_info "Installing dependencies (core + Quickshell Wayland stack)..."

  if command -v pacman >/dev/null 2>&1; then
    sudo pacman -S --needed git curl wget zsh hyprland quickshell hyprpaper hyprlock hypridle cliphist kitty
  elif command -v apt >/dev/null 2>&1; then
    sudo apt update
    sudo apt install -y git curl wget zsh kitty
    echo "âš ï¸  Install hyprland/quickshell/hyprpaper/hyprlock/hypridle/cliphist manually (not all in apt)."
  elif command -v dnf >/dev/null 2>&1; then
    sudo dnf install -y git curl wget zsh hyprland hyprpaper kitty
    echo "â„¹ï¸  Install quickshell, hyprlock, hypridle and cliphist separately if unavailable."
  else
    echo "âŒ Unsupported package manager. Install packages manually."
    exit 1
  fi

  if ! command -v chezmoi >/dev/null 2>&1; then
    echo "ðŸ“¦ Installing chezmoi..."
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b ~/.local/bin
  fi
}

list_dependencies() {
  echo "ðŸ“‹ HorneroConfig Dependencies"
  echo ""

  echo "Core Dependencies:"
  for cmd in "${!CORE_DEPS[@]}"; do
    echo "  - $cmd: ${CORE_DEPS[$cmd]}"
  done

  echo ""
  echo "Wayland Environment Components:"
  for cmd in "${!WL_DEPS[@]}"; do
    echo "  - $cmd: ${WL_DEPS[$cmd]}"
  done

  if [[ -n ${optional} ]]; then
    echo ""
    echo "Development Dependencies (Optional):"
    for cmd in "${!DEV_DEPS[@]}"; do
      echo "  - $cmd: ${DEV_DEPS[$cmd]}"
    done

    echo ""
    echo "Media Dependencies (Optional):"
    for cmd in "${!MEDIA_DEPS[@]}"; do
      echo "  - $cmd: ${MEDIA_DEPS[$cmd]}"
    done
  fi
}

# Main logic
if [[ -n ${check} ]]; then
  check_all_dependencies
elif [[ -n ${install} ]]; then
  install_dependencies
elif [[ -n ${list} ]]; then
  list_dependencies
else
  check_all_dependencies
fi
