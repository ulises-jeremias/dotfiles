#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Settings GUI - Quickshell control center entrypoint

set -euo pipefail

SCRIPT_NAME="$(basename "$0")"
readonly SCRIPT_NAME
PANE=""

set_start_pane() {
  local pane="$1"
  [[ -z "$pane" ]] && return 0
  ~/.local/bin/dots-quickshell config set controlCenter.startPane "$pane" >/dev/null 2>&1 || true
}

open_settings() {
  set_start_pane "$PANE"

  if ! pgrep -x quickshell >/dev/null 2>&1; then
    ~/.local/bin/dots-quickshell start >/dev/null 2>&1 || true
    sleep 1
  fi

  if pgrep -x quickshell >/dev/null 2>&1; then
    ~/.local/bin/dots-quickshell ipc utilities toggle
    return 0
  fi

  echo "Error: quickshell is not running and could not be started" >&2
  return 1
}

# Main
main() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --pane=*)
        PANE="${1#*=}"
        shift
        ;;
      --pane)
        PANE="${2:-}"
        shift 2
        ;;
      *)
        break
        ;;
    esac
  done

  case "${1:-menu}" in
    menu | --menu | -m | "")
      open_settings
      ;;
    help | --help | -h)
      cat <<EOF
Usage: $SCRIPT_NAME [COMMAND]

Central settings hub for system configuration.

Commands:
  menu, -m        Show settings menu (default)
  --pane=NAME     Set initial control-center pane (network|bluetooth|audio|appearance|taskbar|launcher|dashboard|system)
  help, -h        Show this help message

Keybinding suggestion (hyprland):
  bind = SUPER, I, exec, $SCRIPT_NAME menu
  bind = SUPER SHIFT, S, exec, $SCRIPT_NAME menu

Examples:
  $SCRIPT_NAME --pane=appearance
  $SCRIPT_NAME --pane=launcher menu
EOF
      ;;
    *)
      echo "Unknown command: $1" >&2
      echo "Try '$SCRIPT_NAME help' for more information." >&2
      exit 1
      ;;
  esac
}

main "$@"
