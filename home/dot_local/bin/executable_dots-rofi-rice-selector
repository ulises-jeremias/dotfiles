#!/usr/bin/env bash

## Copyright (C) 2019-2025 Ulises Jeremias Cornejo Fandos
## Licensed under MIT.
##
## Check full documentation at: https://github.com/ulises-jeremias/dotfiles/wiki
##
## executable_dots-rofi-rice-selector utility script

set -euo pipefail

# This script defines the variables: DOTS_CACHE_DIR, RICES_DIR and CURRENT_RICE_FILE
# shellcheck disable=SC1091
source "$HOME/.local/lib/dots/dots-rice-config.sh"

# Rofi theme path
ROFI_THEME="$HOME/.config/rofi/riceselector.rasi"

# Function to check dependencies
check_dependencies() {
  if ! command -v hyprctl >/dev/null 2>&1 && ! command -v xdpyinfo >/dev/null 2>&1; then
    echo "Please install hyprland or xorg-xdpyinfo package to continue"
    notify-send "Missing package" "Please install hyprland or xorg-xdpyinfo package to continue" -u critical
    exit 1
  fi
}

# Function to calculate screen parameters
calculate_screen_parameters() {
  # Detect if running on Wayland (Hyprland) or X11
  if command -v hyprctl >/dev/null 2>&1 && [[ "${XDG_SESSION_TYPE:-}" == "wayland" ]]; then
    # Wayland/Hyprland method - use focused monitor, fallback to first
    monitor_info=$(hyprctl monitors -j | jq -r '(map(select(.focused == true)) | .[0]) // .[0]')
    monitor_res=$(echo "$monitor_info" | jq -r '.width')
    monitor_height=$(echo "$monitor_info" | jq -r '.height')
    monitor_scale=$(echo "$monitor_info" | jq -r '.scale')
    primary_monitor=$(echo "$monitor_info" | jq -r '.name')

    # Hyprland scale is a float, convert to DPI-like value (96 is base)
    monitor_scale=$(awk "BEGIN {print int(96 * $monitor_scale)}")
  else
    # X11 fallback method
    primary_monitor=$(xrandr | awk '/ connected primary/ {print $1}')
    if [ -z "$primary_monitor" ]; then
      primary_monitor=$(xrandr | awk '/ connected/ {print $1; exit}')
    fi

    monitor_geometry=$(xrandr | grep "^$primary_monitor connected" | grep -oP '\d+x\d+\+\d+\+\d+')
    monitor_res=$(echo "$monitor_geometry" | cut -d '+' -f1 | cut -d 'x' -f1)
    monitor_height=$(echo "$monitor_geometry" | cut -d '+' -f1 | cut -d 'x' -f2)

    monitor_scale=$(xdpyinfo | awk '/resolution/{print $2}' | cut -d 'x' -f1)
  fi

  if [ -z "$monitor_res" ] || [ -z "$monitor_height" ]; then
    echo "Could not determine resolution for monitor $primary_monitor"
    exit 1
  fi

  echo "Monitor: $primary_monitor | Width: $monitor_res | Height: $monitor_height | Scale: $monitor_scale" >&2

  # Validate that monitor_scale is not zero
  if [ -z "$monitor_scale" ] || [ "$monitor_scale" -eq 0 ]; then
    echo "Error: Monitor scale could not be determined or is zero."
    exit 1
  fi

  # Calculate element size based on screen - aim for 5-6 columns
  # For 1920px width with 5 columns: ~300px per element, icon ~200px
  element_size_min=150
  element_size_max=220
  element_size_factor=0.11 # ~11% of screen width per icon
  element_size=$(awk "BEGIN {
    size = ($monitor_res * $element_size_factor / ($monitor_scale / 96));
    if (size < $element_size_min) size = $element_size_min;
    if (size > $element_size_max) size = $element_size_max;
    print int(size)
  }")

  # Adjust the mainbox to use more screen space
  mainbox_height_factor=0.85 # 85% of the monitor height
  mainbox_height=$(awk "BEGIN {print int($monitor_height * $mainbox_height_factor)}")

  # Calculate vertical padding for top and bottom
  total_vertical_space=$(awk "BEGIN {print $monitor_height - $mainbox_height}")
  padding_top_factor=0.4
  padding_bottom_factor=0.4

  padding_top=$(awk "BEGIN {padding = $total_vertical_space * $padding_top_factor; if (padding < 0) padding = 0; print int(padding)}")
  padding_bottom=$(awk "BEGIN {padding = $total_vertical_space * $padding_bottom_factor; if (padding < 0) padding = 0; print int(padding)}")

  # Generate dynamic styles for Rofi
  rofi_override="element-icon{size:${element_size}px;} window{padding:${padding_top}px 20px ${padding_bottom}px 20px;}"
}

# Function to get rice metadata from config.sh
# Returns: RICE_NAME|RICE_DESCRIPTION|RICE_STYLE|WAYBAR_PROFILE|PREFER_DARK_THEME|GTK_THEME
get_rice_metadata() {
  local rice_name="$1"
  local config_file="${RICES_DIR}/${rice_name}/config.sh"

  local display_name="$rice_name"
  local description=""
  local style=""
  local waybar_profile=""
  local theme_mode=""
  local gtk_theme=""

  if [[ -f $config_file ]]; then
    # Extract metadata using grep (safer than sourcing)
    display_name=$(grep -E "^RICE_NAME=" "$config_file" 2>/dev/null | cut -d'"' -f2) || display_name="$rice_name"
    description=$(grep -E "^RICE_DESCRIPTION=" "$config_file" 2>/dev/null | cut -d'"' -f2) || description=""
    style=$(grep -E "^RICE_STYLE=" "$config_file" 2>/dev/null | cut -d'"' -f2) || style=""
    waybar_profile=$(grep -E "^WAYBAR_PROFILE=" "$config_file" 2>/dev/null | cut -d'"' -f2) || waybar_profile=""
    theme_mode=$(grep -E "^PREFER_DARK_THEME=" "$config_file" 2>/dev/null | cut -d'"' -f2) || theme_mode=""
    gtk_theme=$(grep -E "^GTK_THEME=" "$config_file" 2>/dev/null | cut -d'"' -f2) || gtk_theme=""

    # Fallback to rice_name if RICE_NAME is empty
    [[ -z $display_name ]] && display_name="$rice_name"
  fi

  echo "${display_name}|${description}|${style}|${waybar_profile}|${theme_mode}|${gtk_theme}"
}

# Function to get rice category based on style
get_rice_category() {
  local style="$1"
  local category="âœ¨ Other"

  style=$(echo "$style" | tr '[:upper:]' '[:lower:]')

  case "$style" in
    *cyberpunk* | *neon* | *synthwave* | *futuristic*)
      category="ðŸŒƒ Cyberpunk & Neon"
      ;;
    *cozy* | *kawaii* | *pastel* | *soft*)
      category="ðŸŒ¸ Cozy & Cute"
      ;;
    *vaporwave* | *retro* | *80s* | *90s*)
      category="ðŸŒ´ Retro & Vaporwave"
      ;;
    *nature* | *landscape* | *fresh*)
      category="ðŸŒ¿ Nature & Fresh"
      ;;
    *gruvbox* | *warm* | *anime*)
      category="ðŸŽ¨ Warm & Artistic"
      ;;
    *minimal* | *clean* | *productive*)
      category="ðŸ’¼ Minimal & Productive"
      ;;
    *space* | *cosmic* | *dark*)
      category="ðŸŒŒ Dark & Cosmic"
      ;;
  esac

  echo "$category"
}

# Function to list available rices with categories and metadata
list_rices() {
  options=()
  categories=()
  rice_display_names=()
  rice_descriptions=()
  rice_styles=()
  rice_waybar_profiles=()
  rice_theme_modes=()
  rice_gtk_themes=()
  index=0
  selected_index=0
  current_rice=""

  if [[ -f $CURRENT_RICE_FILE ]]; then
    current_rice=$(<"$CURRENT_RICE_FILE")
  fi

  # First pass: collect all rices and their categories with metadata
  declare -A rice_by_category
  declare -A rice_metadata_cache

  for rice_dir in "${RICES_DIR}"/*/; do
    rice_name=$(basename "$rice_dir")
    # Skip directories that don't have config.sh
    [[ -f "${rice_dir}/config.sh" ]] || continue

    # Get metadata: RICE_NAME|RICE_DESCRIPTION|RICE_STYLE|WAYBAR_PROFILE|PREFER_DARK_THEME|GTK_THEME
    local metadata
    metadata=$(get_rice_metadata "$rice_name")
    rice_metadata_cache["$rice_name"]="$metadata"

    local style
    style=$(echo "$metadata" | cut -d'|' -f3)
    local category
    category=$(get_rice_category "$style")
    rice_by_category["$category"]+="$rice_name "
  done

  # Sort categories in preferred order
  local preferred_order=(
    "ðŸŒƒ Cyberpunk & Neon"
    "ðŸŒ´ Retro & Vaporwave"
    "ðŸŒ¸ Cozy & Cute"
    "ðŸŽ¨ Warm & Artistic"
    "ðŸŒ¿ Nature & Fresh"
    "ðŸŒŒ Dark & Cosmic"
    "ðŸ’¼ Minimal & Productive"
    "âœ¨ Other"
  )

  # Build options array in category order
  for category in "${preferred_order[@]}"; do
    if [[ -n ${rice_by_category[$category]:-} ]]; then
      for rice_name in ${rice_by_category[$category]}; do
        local metadata="${rice_metadata_cache[$rice_name]}"
        local display_name
        display_name=$(echo "$metadata" | cut -d'|' -f1)
        local description
        description=$(echo "$metadata" | cut -d'|' -f2)
        local style
        style=$(echo "$metadata" | cut -d'|' -f3)
        local waybar_profile
        waybar_profile=$(echo "$metadata" | cut -d'|' -f4)
        local theme_mode
        theme_mode=$(echo "$metadata" | cut -d'|' -f5)
        local gtk_theme
        gtk_theme=$(echo "$metadata" | cut -d'|' -f6)

        options+=("$rice_name")
        categories+=("$category")
        rice_display_names+=("$display_name")
        rice_descriptions+=("$description")
        rice_styles+=("$style")
        rice_waybar_profiles+=("$waybar_profile")
        rice_theme_modes+=("$theme_mode")
        rice_gtk_themes+=("$gtk_theme")

        if [[ $current_rice == "$rice_name" ]]; then
          selected_index=$index
        fi

        index=$((index + 1))
      done
    fi
  done

  if [ ${#options[@]} -eq 0 ]; then
    echo "No rices found in $RICES_DIR"
    exit 1
  fi
}

# Function to show rofi menu and select rice with categories
select_rice() {
  local menu_items=""
  local idx=0

  for rice_name in "${options[@]}"; do
    local category="${categories[$idx]}"
    local display_name="${rice_display_names[$idx]}"
    local style="${rice_styles[$idx]}"
    local waybar="${rice_waybar_profiles[$idx]}"
    local theme_mode="${rice_theme_modes[$idx]}"
    local gtk="${rice_gtk_themes[$idx]}"

    # Get category emoji
    local category_emoji
    category_emoji=$(echo "$category" | cut -d' ' -f1)

    # Get theme mode icon
    local mode_icon=""
    case "$theme_mode" in
      dark) mode_icon="ðŸŒ™" ;;
      light) mode_icon="â˜€ï¸" ;;
      auto) mode_icon="ðŸ”„" ;;
      *) mode_icon="" ;;
    esac

    # Build display text with useful info
    # Format: Name ðŸŒƒ Â· Style Â· ó°œ waybar Â· ï¿½ostrom gtk Â· ðŸŒ™
    local display_text="${display_name} ${category_emoji}"

    # Add style if available
    [[ -n $style ]] && display_text="${display_text} Â· ${style}"

    # Add waybar profile if available (with icon)
    [[ -n $waybar ]] && display_text="${display_text} Â· ó°œ ${waybar}"

    # Add GTK theme if available (with icon, shortened)
    if [[ -n $gtk ]]; then
      # Shorten long GTK theme names
      local gtk_short="$gtk"
      if [[ ${#gtk} -gt 20 ]]; then
        gtk_short="${gtk:0:17}..."
      fi
      display_text="${display_text} Â·  ${gtk_short}"
    fi

    # Add mode icon at the end
    [[ -n $mode_icon ]] && display_text="${display_text} ${mode_icon}"

    menu_items+="${display_text}\x00icon\x1f${RICES_DIR}/${rice_name}/preview.png\x1fmeta\x1f${rice_name}\n"
    idx=$((idx + 1))
  done

  selected=$(echo -en "$menu_items" | rofi -dmenu -theme "$ROFI_THEME" -theme-str "$rofi_override" -selected-row "$selected_index" -p "Select Rice")

  [[ -n $selected ]] || exit 1

  # Extract display name (first part before emoji/separator)
  local selected_display
  selected_display=$(echo "$selected" | sed 's/ [ðŸŒƒðŸŒ´ðŸŒ¸ðŸŽ¨ðŸŒ¿ðŸŒŒðŸ’¼âœ¨].*$//' | xargs)

  # Find matching rice by display name
  local matched_rice=""
  for i in "${!options[@]}"; do
    local rice="${options[$i]}"
    local disp="${rice_display_names[$i]}"
    if [[ $selected_display == "$disp" ]]; then
      matched_rice="$rice"
      break
    fi
  done

  # Fallback: try to match by rice folder name
  if [[ -z $matched_rice ]]; then
    for rice in "${options[@]}"; do
      if [[ $selected_display == *"$rice"* ]] || [[ $rice == *"$selected_display"* ]]; then
        matched_rice="$rice"
        break
      fi
    done
  fi

  if [[ -z $matched_rice ]]; then
    echo "Could not determine selected rice from: $selected"
    exit 1
  fi

  selected="$matched_rice"
  echo "$selected" >"$CURRENT_RICE_FILE"
}

# Function to list and select a background image
select_background_image() {
  local backgrounds_dir="${RICES_DIR}/${selected}/backgrounds"
  [[ -d $backgrounds_dir ]] || {
    echo "No backgrounds directory found for $selected"
    exit 1
  }

  local images=()
  for image in "$backgrounds_dir"/*; do
    images+=("$(basename "$image")")
  done

  selected_image=$(printf "%s\n" "${images[@]}" | while read -r A; do echo -en "$A\x00icon\x1f$backgrounds_dir/$A\n"; done | rofi -dmenu -theme "$ROFI_THEME" -theme-str "$rofi_override")
  [[ -n $selected_image ]] || exit 1
}

# Function to apply the selected rice with the chosen background
apply_rice() {
  if [[ -x "${RICES_DIR}"/"$selected"/apply.sh ]]; then
    BACKGROUND_IMAGE="$selected_image" "${RICES_DIR}"/"$selected"/apply.sh
    if command -v dots-snappy-switcher >/dev/null 2>&1; then
      dots-snappy-switcher apply-rice-theme "$selected" >/dev/null 2>&1 || true
    fi
    exit 0
  else
    echo "Apply script not found or not executable for $selected"
    exit 1
  fi
}

# Main script execution
main() {
  check_dependencies
  calculate_screen_parameters
  list_rices
  select_rice
  select_background_image
  apply_rice
}

main
