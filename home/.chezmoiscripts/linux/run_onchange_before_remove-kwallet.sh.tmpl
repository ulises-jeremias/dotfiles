{{ if eq .osid "linux-arch" -}}
#!/usr/bin/env bash

set -euo pipefail

# Stop and disable kwalletd service
if systemctl --user list-unit-files | grep -q kwalletd; then
  echo "Stopping kwalletd service..."
  systemctl --user stop kwalletd5.service 2>/dev/null || true
  systemctl --user stop kwalletd6.service 2>/dev/null || true
  systemctl --user disable kwalletd5.service 2>/dev/null || true
  systemctl --user disable kwalletd6.service 2>/dev/null || true
fi

# Remove KWallet packages (non-destructive - only if explicitly installed)
KDE_PACKAGES=$(pacman -Qq | grep -E '^kwallet|^kwalletmanager' || true)

if [ -n "$KDE_PACKAGES" ]; then
  echo "Removing KWallet packages: $KDE_PACKAGES"
  {{ $sudo := "sudo " -}}
  {{ if eq .chezmoi.username "root" -}}
  {{   $sudo = "" -}}
  {{ end -}}
  {{ $sudo }}pacman -Rns --noconfirm $KDE_PACKAGES || {
    echo "⚠️  Some KWallet packages could not be removed (may be dependencies)"
    echo "   This is safe - they will be ignored if not actively used"
  }
else
  echo "ℹ️  No KWallet packages found to remove"
fi

echo "✅ KWallet removal completed"

{{ end -}}
