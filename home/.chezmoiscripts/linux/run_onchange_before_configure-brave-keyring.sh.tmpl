{{ if eq .osid "linux-arch" -}}
#!/usr/bin/env bash

set -euo pipefail

# Configure Brave to use Secret Service instead of KWallet
BRAVE_DESKTOP_SOURCE="/usr/share/applications/brave-browser.desktop"
BRAVE_DESKTOP_OVERRIDE_DIR="${HOME}/.local/share/applications"
BRAVE_DESKTOP_OVERRIDE="${BRAVE_DESKTOP_OVERRIDE_DIR}/brave-browser.desktop"

if [ ! -f "$BRAVE_DESKTOP_SOURCE" ]; then
  echo "⚠️  Brave desktop file not found: $BRAVE_DESKTOP_SOURCE"
  exit 0
fi

# Create override directory if it doesn't exist
mkdir -p "$BRAVE_DESKTOP_OVERRIDE_DIR"

# Backup existing override if present
if [ -f "$BRAVE_DESKTOP_OVERRIDE" ]; then
  cp "$BRAVE_DESKTOP_OVERRIDE" "${BRAVE_DESKTOP_OVERRIDE}.bak.$(date +%Y%m%d_%H%M%S)"
fi

# Copy the original desktop file content and modify Exec lines
# PASSWORD_STORE=basic forces Chromium/Brave to use Secret Service API instead of KWallet
while IFS= read -r line; do
  if [[ "$line" =~ ^Exec= ]]; then
    # Add PASSWORD_STORE=basic environment variable to Exec lines
    echo "${line/Exec=/Exec=env PASSWORD_STORE=basic }" >> "$BRAVE_DESKTOP_OVERRIDE"
  else
    echo "$line" >> "$BRAVE_DESKTOP_OVERRIDE"
  fi
done < "$BRAVE_DESKTOP_SOURCE"

# Ensure desktop file is executable (some desktop environments require this)
chmod +x "$BRAVE_DESKTOP_OVERRIDE" 2>/dev/null || true

echo "✅ Brave configured to use Secret Service (gnome-keyring)"

{{ end -}}
