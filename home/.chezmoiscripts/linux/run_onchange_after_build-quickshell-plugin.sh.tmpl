{{ if and (not .ephemeral) (not .headless) -}}

{{      if eq .osid "linux-arch" -}}
#!/usr/bin/env bash

set -euo pipefail

source "${HOME}/.local/lib/dots/logging.sh"

SHELL_DIR="${HOME}/.config/quickshell"
PLUGIN_DIR="${SHELL_DIR}/plugin"
BUILD_ROOT_DIR="${SHELL_DIR}"
BUILD_DIR="${XDG_CACHE_HOME:-${HOME}/.cache}/dots/quickshell/build"
INSTALL_PREFIX="${HOME}/.local/lib/quickshell"

if [[ ! -d "$SHELL_DIR" ]]; then
    log_warn "Quickshell directory not found, skipping build"
    exit 0
fi

if ! command -v cmake &>/dev/null; then
    log_warn "cmake not found, skipping plugin build"
    exit 0
fi

log_info "Building Hornero Quickshell plugin..."

if [[ ! -f "${BUILD_ROOT_DIR}/CMakeLists.txt" ]]; then
    log_warn "Missing CMakeLists.txt in ${BUILD_ROOT_DIR}, skipping plugin build"
    exit 0
fi

mkdir -p "$BUILD_DIR"

VERSION_FROM_GIT="v0.0.0"
GIT_REVISION_FROM_GIT="unknown"
if command -v git &>/dev/null; then
    if git -C "$HOME/.dotfiles" rev-parse --is-inside-work-tree &>/dev/null; then
        VERSION_FROM_GIT="$(git -C "$HOME/.dotfiles" describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")"
        GIT_REVISION_FROM_GIT="$(git -C "$HOME/.dotfiles" rev-parse HEAD 2>/dev/null || echo "unknown")"
    fi
fi

cmake -S "$BUILD_ROOT_DIR" -B "$BUILD_DIR" -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX" \
    -DINSTALL_QMLDIR="$INSTALL_PREFIX/qml" \
    -DVERSION="$VERSION_FROM_GIT" \
    -DGIT_REVISION="$GIT_REVISION_FROM_GIT" 2>&1 | while IFS= read -r line; do
    log_debug "$line"
done

cmake --build "$BUILD_DIR" 2>&1 | while IFS= read -r line; do
    log_debug "$line"
done

cmake --install "$BUILD_DIR" 2>&1 | while IFS= read -r line; do
    log_debug "$line"
done

log_info "Hornero Quickshell plugin built and installed to ${INSTALL_PREFIX}"

{{      end -}}

{{ end -}}
