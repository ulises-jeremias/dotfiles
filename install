#!/usr/bin/env sh

ROOT="$(realpath "$(dirname "$0")")"
PKGNAME=${PKGNAME:-"dots"}

# override OS with a correct value with the given params
# creates variable `os`
. "${ROOT}"/util/os.sh

rm -rf "${DESTDIR}/opt/${PKGNAME}" \
    "${DESTDIR}/usr/bin/dots" \
    "${DESTDIR}/usr/share/licenses/${PKGNAME}/" \
    "${DESTDIR}/usr/share/doc/${PKGNAME}/"

install -d "${DESTDIR}/opt/${PKGNAME}"

for dirname in common "${os}" ui util; do
    cp -Rf "${ROOT}"/"${dirname}" "${DESTDIR}/opt/${PKGNAME}"
done

install -Dm644 "${ROOT}"/LICENSE -t "${DESTDIR}/usr/share/licenses/${PKGNAME}/"
install -Dm644 "${ROOT}"/README.md -t "${DESTDIR}/usr/share/doc/${PKGNAME}/"
install -Dm755 "${ROOT}"/dots -t "${DESTDIR}/opt/${PKGNAME}/"

mkdir -p "${DESTDIR}"/usr/bin

# Create dots binary at ${DESTDIR}/usr/bin/${PKGNAME} to wrap the file at ${DESTDIR}/opt/${PKGNAME}/dots
cat > "${DESTDIR}"/usr/bin/"${PKGNAME}" <<EOF
#!/usr/bin/env sh

${DESTDIR}/opt/${PKGNAME}/dots "\$@"
EOF

chmod +x "${DESTDIR}/usr/bin/${PKGNAME}"
